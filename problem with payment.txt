

CREATE TABLE Student_Fees (
    student_fee_id INT AUTO_INCREMENT PRIMARY KEY,
    enrollment_id INT NOT NULL,
    structure_id INT NOT NULL,
    section_id INT NOT NULL,
    session_year VARCHAR(20) NOT NULL,
    term INT NOT NULL DEFAULT 1;
    total_fee DECIMAL(10,2) NOT NULL CHECK (total_fee >= 0),
    amount_paid DECIMAL(10,2) DEFAULT 0.00 CHECK (amount_paid >= 0),
    status ENUM('Pending', 'Completed') DEFAULT 'Pending',
    remaining_amount DECIMAL(10,2) GENERATED ALWAYS AS (total_fee - amount_paid) STORED,
    created_date DATE DEFAULT CURRENT_DATE,
    updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (enrollment_id) REFERENCES Student_Enrollments(enrollment_id),
    FOREIGN KEY (section_id) REFERENCES Sections(section_id),
    FOREIGN KEY (session_year) REFERENCES Sessions(session_year),
    UNIQUE KEY unique_student_fee (enrollment_id, structure_id, session_year)
);

-- =========================
-- Student Fee Payments
-- =========================
CREATE TABLE Student_Fee_Payments (
    payment_id INT AUTO_INCREMENT PRIMARY KEY,
    student_fee_id INT NOT NULL,
    session_year VARCHAR(20) NOT NULL,
    class_ref INT NOT NULL,
    section_id INT NOT NULL DEFAULT 1,
    payment_amount DECIMAL(10,2) NOT NULL CHECK (payment_amount > 0),
    payment_date DATE DEFAULT CURRENT_DATE,
    term INT NOT NULL DEFAULT 1,
    payment_method VARCHAR(50) DEFAULT NULL,
    receipt_number VARCHAR(100) DEFAULT NULL,
    notes TEXT DEFAULT NULL,
    FOREIGN KEY (student_fee_id) REFERENCES Student_Fees(student_fee_id),
    FOREIGN KEY (session_year) REFERENCES Sessions(session_year)
);

CREATE TABLE Students (
    id INT AUTO_INCREMENT PRIMARY KEY,                  -- internal numeric PK
    student_id VARCHAR(50) UNIQUE NOT NULL,             -- manual student ID (e.g., HIR/25/TAH/0001)
    full_name VARCHAR(100) NOT NULL,                    -- ✅ changed from name -> full_name
    date_of_birth DATE NOT NULL,
    gender VARCHAR(10) NOT NULL CHECK (gender IN ('Male', 'Female', 'Other')),
    guardian_phone VARCHAR(20) DEFAULT NULL,            -- ✅ changed from phone -> guardian_phone
    address TEXT NOT NULL,
    email VARCHAR(255) DEFAULT NULL,
    profile_picture VARCHAR(255) DEFAULT '/uploads/students/default.jpg', -- consistent with your modal
    created_date DATE DEFAULT CURRENT_DATE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE Student_Enrollments (
    enrollment_id INT AUTO_INCREMENT PRIMARY KEY,
    student_id INT NOT NULL,   -- references Students.id (numeric PK)
    section_id INT NOT NULL,
    class_ref INT NOT NULL,
    level INT NOT NULL,
    term INT NOT NULL CHECK (term >= 1),
    enrollment_date DATE DEFAULT CURRENT_DATE,
    FOREIGN KEY (student_ref) REFERENCES Students(id) ON DELETE CASCADE,
    FOREIGN KEY (section_id) REFERENCES Sections(section_id),
    UNIQUE KEY unique_enrollment (student_ref, section_id, class_ref, term)
);

-- =========================
-- Trigger to Update Student Fee Status
-- =========================
DELIMITER //
CREATE TRIGGER update_student_fee_status_after_payment
AFTER INSERT ON Student_Fee_Payments
FOR EACH ROW
BEGIN
    UPDATE Student_Fees sf
    SET 
        amount_paid = amount_paid + NEW.payment_amount,
        status = CASE 
            WHEN (amount_paid + NEW.payment_amount) >= total_fee THEN 'Completed'
            ELSE 'Pending'
        END
    WHERE sf.student_fee_id = NEW.student_fee_id;
END//
DELIMITER ;
-- =========================
-- Fee Structures
-- =========================
CREATE TABLE Islamic_Fee_Structures (
    structure_id INT AUTO_INCREMENT PRIMARY KEY,
    class_id INT NOT NULL,
    term INT NOT NULL CHECK (term >= 1),
    session_year VARCHAR(20) NOT NULL,
    total_fee DECIMAL(10,2) NOT NULL CHECK (total_fee >= 0),
    description TEXT DEFAULT NULL,
    created_date DATE DEFAULT CURRENT_DATE,
    FOREIGN KEY (class_id) REFERENCES Classes(class_id),
    FOREIGN KEY (session_year) REFERENCES Sessions(session_year),
    UNIQUE KEY unique_fee_structure (class_id, term, session_year)
);

CREATE TABLE Western_Fee_Structures (
    structure_id INT AUTO_INCREMENT PRIMARY KEY,
    western_class_id INT NOT NULL,
    term INT NOT NULL CHECK (term >= 1),
    session_year VARCHAR(20) NOT NULL,
    total_fee DECIMAL(10,2) NOT NULL CHECK (total_fee >= 0),
    description TEXT DEFAULT NULL,
    created_date DATE DEFAULT CURRENT_DATE,
    FOREIGN KEY (western_class_id) REFERENCES Western_Classes(western_class_id),
    FOREIGN KEY (session_year) REFERENCES Sessions(session_year),
    UNIQUE KEY unique_fee_structure (western_class_id, term, session_year)
);

-- =========================
-- Students
-- =========================
CREATE TABLE Students (
    id INT AUTO_INCREMENT PRIMARY KEY,                  -- internal numeric PK
    student_id VARCHAR(50) UNIQUE NOT NULL,             -- manual student ID (e.g., HIR/25/TAH/0001)
    full_name VARCHAR(100) NOT NULL,                    -- ✅ changed from name -> full_name
    date_of_birth DATE NOT NULL,
    gender VARCHAR(10) NOT NULL CHECK (gender IN ('Male', 'Female', 'Other')),
    guardian_phone VARCHAR(20) DEFAULT NULL,            -- ✅ changed from phone -> guardian_phone
    address TEXT NOT NULL,
    email VARCHAR(255) DEFAULT NULL,
    profile_picture VARCHAR(255) DEFAULT '/uploads/students/default.jpg', -- consistent with your modal
    created_date DATE DEFAULT CURRENT_DATE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Student_Enrollments (
    enrollment_id INT AUTO_INCREMENT PRIMARY KEY,
    student_id INT NOT NULL,   -- references Students.id (numeric PK)
    section_id INT NOT NULL,
    class_ref INT NOT NULL,
    level INT NOT NULL,
    term INT NOT NULL CHECK (term >= 1),
    enrollment_date DATE DEFAULT CURRENT_DATE,
    FOREIGN KEY (student_ref) REFERENCES Students(id) ON DELETE CASCADE,
    FOREIGN KEY (section_id) REFERENCES Sections(section_id),
    UNIQUE KEY unique_enrollment (student_ref, section_id, class_ref, term)
);

// ==========================
// GET SINGLE STUDENT
// ==========================
app.get('/api/students/:id', (req, res) => {
    if (!req.session.isAuthenticated) {
        return res.status(401).json({ success: false, message: 'Unauthorized.' });
    }

    const studentId = req.params.id;

    const studentQuery = `
        SELECT 
            s.id,
            s.student_id,
            s.full_name AS name,
            s.gender,
            DATE_FORMAT(s.date_of_birth, '%Y-%m-%d') AS date_of_birth,
            s.guardian_phone,
            s.address,
            s.email,
            s.profile_picture,
            GROUP_CONCAT(
                CONCAT(se.section_id, ':', se.class_ref)
                ORDER BY se.section_id, se.class_ref SEPARATOR ','
            ) AS classes,
            GROUP_CONCAT(
                DISTINCT sub.subject_name
                ORDER BY sub.subject_name SEPARATOR ', '
            ) AS subjects
        FROM Students s
        LEFT JOIN Student_Enrollments se ON s.id = se.student_id
        LEFT JOIN Student_Subjects ss ON se.enrollment_id = ss.enrollment_id
        LEFT JOIN Subjects sub ON ss.subject_id = sub.subject_id
        WHERE s.id = ?
        GROUP BY s.id
    `;

    db.query(studentQuery, [studentId], (err, studentResults) => {
        if (err) {
            console.error('Error fetching student:', err);
            return res.status(500).json({ success: false, message: 'Database error.', error: err.message });
        }

        if (studentResults.length === 0) {
            return res.status(404).json({ success: false, message: 'Student not found.' });
        }

        const student = studentResults[0];

        // ✅ Profile picture handling
        student.profile_picture = student.profile_picture
            ? 'Uploads/' + student.profile_picture.split('/').pop()
            : 'Uploads/default.jpg';

        // ✅ Convert comma-separated classes to array
        student.classes = student.classes ? student.classes.split(',') : [];

        // ✅ Convert comma-separated subject names to array
        student.subjects = student.subjects ? student.subjects.split(', ') : [];

        res.status(200).json({ success: true, data: student });
    });
});

// ==========================
// POST ADD STUDENT
// ==========================
app.post('/api/students', upload.single('profile_picture'), (req, res) => {
    const {
        student_id, full_name, guardian_phone, email, address, gender,
        date_of_birth, level = 1, term = 1
    } = req.body;

    // Updated: Handle both classes/classes[] and subjects/subjects[]
    const classes = req.body['classes[]'] || req.body.classes
        ? (Array.isArray(req.body['classes[]'] || req.body.classes)
            ? (req.body['classes[]'] || req.body.classes)
            : [(req.body['classes[]'] || req.body.classes)])
        : [];
    const subjects = req.body['subjects[]'] || req.body.subjects
        ? (Array.isArray(req.body['subjects[]'] || req.body.subjects)
            ? (req.body['subjects[]'] || req.body.subjects).map(s => s.includes(':') ? s.split(':')[1] : s)
            : [(req.body['subjects[]'] || req.body.subjects).includes(':') ? (req.body['subjects[]'] || req.body.subjects).split(':')[1] : (req.body['subjects[]'] || req.body.subjects)])
        : [];

    console.log('Received request body:', req.body); // Debug
    console.log('Processed classes:', classes); // Debug
    console.log('Processed subjects:', subjects); // Debug

    // Validate inputs
    if (!student_id || !full_name || !guardian_phone || !address || !gender || !date_of_birth) {
        return res.status(400).json({ success: false, message: 'Missing required fields.' });
    }
    if (classes.length === 0) {
        return res.status(400).json({ success: false, message: 'At least one class is required.' });
    }

    // Validate classes
    const classQueries = classes.map(cls => {
        const [section_id, class_ref] = cls.split(':').map(Number);
        const table = section_id === 1 ? 'Classes' : 'Western_Classes';
        const idField = section_id === 1 ? 'class_id' : 'western_class_id';
        return `SELECT ${idField} FROM ${table} WHERE ${idField} = ${class_ref}`;
    });

    db.query(classQueries.join(' UNION '), (err, validClasses) => {
        if (err) {
            console.error('Error validating classes:', err);
            return res.status(500).json({ success: false, message: 'Failed to validate classes.', error: err.message });
        }
        const validClassIds = validClasses.map(c => c.class_id || c.western_class_id);
        const invalidClasses = classes.filter(cls => {
            const [, class_ref] = cls.split(':').map(Number);
            return !validClassIds.includes(class_ref);
        });
        if (invalidClasses.length > 0) {
            return res.status(400).json({ success: false, message: 'Invalid class IDs provided.' });
        }

        // Validate subjects
        if (subjects.length > 0) {
            db.query(`SELECT subject_id FROM Subjects WHERE subject_id IN (?)`, [subjects.map(Number)], (err2, validSubjects) => {
                if (err2) {
                    console.error('Error validating subjects:', err2);
                    return res.status(500).json({ success: false, message: 'Failed to validate subjects.', error: err2.message });
                }
                const validSubjectIds = validSubjects.map(s => s.subject_id);
                const invalidSubjects = subjects.filter(sub => !validSubjectIds.includes(Number(sub)));
                if (invalidSubjects.length > 0) {
                    return res.status(400).json({ success: false, message: 'Invalid subject IDs provided.' });
                }
                proceedWithInsert();
            });
        } else {
            proceedWithInsert();
        }
    });

    function proceedWithInsert() {
        // Validate date_of_birth
        let parsedDob;
        if (date_of_birth.includes('/')) {
            parsedDob = moment(date_of_birth, 'DD/MM/YYYY', true);
            if (!parsedDob.isValid()) return res.status(400).json({ success: false, message: 'Invalid Date of Birth format. Use DD/MM/YYYY.' });
        } else {
            parsedDob = moment(date_of_birth, 'YYYY-MM-DD', true);
            if (!parsedDob.isValid()) return res.status(400).json({ success: false, message: 'Invalid Date of Birth format. Use YYYY-MM-DD.' });
        }
        const formattedDob = parsedDob.format('YYYY-MM-DD');

        const profilePic = req.file ? req.file.filename : null;

        // Insert student
        const insertStudentSql = `
            INSERT INTO Students (student_id, full_name, guardian_phone, email, address, gender, date_of_birth, profile_picture)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        `;

        db.query(insertStudentSql, [student_id, full_name, guardian_phone, email || null, address, gender, formattedDob, profilePic], (err, result) => {
            if (err) {
                console.error('Error inserting student:', err);
                return res.status(500).json({ success: false, message: 'Failed to save student.', error: err.message });
            }

            const studentDbId = result.insertId;

            // Insert enrollments
            const enrollSql = `
                INSERT INTO Student_Enrollments (student_id, section_id, class_ref, level, term)
                VALUES ?
            `;
            const enrollValues = classes.map(cls => {
                const [section_id, class_ref] = cls.split(':').map(Number);
                return [studentDbId, section_id, class_ref, level, term];
            });

            db.query(enrollSql, [enrollValues], (err2, enrResult) => {
                if (err2) {
                    console.error('Error inserting enrollments:', err2);
                    return res.status(500).json({ success: false, message: 'Failed to save enrollments.', error: err2.message });
                }

                if (subjects.length > 0) {
                    // Fetch enrollment IDs
                    db.query(`SELECT enrollment_id FROM Student_Enrollments WHERE student_id = ?`, [studentDbId], (err3, enrollments) => {
                        if (err3) {
                            console.error('Error fetching enrollments:', err3);
                            return res.status(500).json({ success: false, message: 'Failed to fetch enrollments.', error: err3.message });
                        }

                        const subjSql = `INSERT INTO Student_Subjects (enrollment_id, subject_id, term) VALUES ?`;
                        const subjValues = enrollments.reduce((acc, enrollment) => {
                            subjects.forEach(sub => {
                                acc.push([enrollment.enrollment_id, Number(sub), term]);
                            });
                            return acc;
                        }, []);

                        if (subjValues.length > 0) {
                            db.query(subjSql, [subjValues], (err4) => {
                                if (err4) {
                                    console.error('Error inserting subjects:', err4);
                                    return res.status(500).json({ success: false, message: 'Failed to save subjects.', error: err4.message });
                                }
                                res.json({ success: true, data: { id: studentDbId } });
                            });
                        } else {
                            res.json({ success: true, data: { id: studentDbId } });
                        }
                    });
                } else {
                    res.json({ success: true, data: { id: studentDbId } });
                }
            });
        });
    }
});


// ================================================================
//  FEES MANAGEMENT – FULLY UPDATED BACKEND
//  Supports: Student ID → Payment → Auto-create Student_Fees
// ================================================================

// GET sessions
app.get('/api/sessions', (req, res) => {
    if (!req.session.isAuthenticated) {
        return res.status(401).json({ success: false, message: 'Unauthorized.' });
    }

    const query = `
        SELECT session_year, is_current
        FROM Sessions
        ORDER BY start_date DESC
    `;

    db.query(query, (err, results) => {
        if (err) {
            console.error('Error fetching sessions:', err);
            return res.status(500).json({ success: false, message: 'Database error.', error: err.message });
        }
        res.status(200).json({ success: true, data: results });
    });
});

// GET student by admission number (for modal)
app.get('/api/students/by-admission/:admission', (req, res) => {
    if (!req.session.isAuthenticated) {
        return res.status(401).json({ success: false, message: 'Unauthorized.' });
    }

    const admission = req.params.admission.trim();
    const sql = `
        SELECT 
            s.id,
            s.full_name,
            s.student_id AS admission_no,
            se.section_id,
            se.class_ref
        FROM Students s
        LEFT JOIN Student_Enrollments se ON s.id = se.student_id
        WHERE s.student_id = ?
        LIMIT 1
    `;

    db.query(sql, [admission], (err, rows) => {
        if (err || !rows.length) {
            console.error('Student not found:', err);
            return res.status(404).json({ success: false, message: 'Student not found' });
        }
        res.json({ success: true, data: rows[0] });
    });
});

// GET fee structures (overview)
app.get('/api/fees/structures', (req, res) => {
    if (!req.session.isAuthenticated) {
        return res.status(401).json({ success: false, message: 'Unauthorized.' });
    }

    const { session, term } = req.query;
    if (!session) {
        return res.status(400).json({ success: false, message: 'Session year is required.' });
    }

    const params = [session];
    let termClause = '';
    if (term) {
        termClause = ` AND term = ?`;
        params.push(parseInt(term));
    }

    const query = `
        SELECT 
            structure_id, 
            class_id AS class_ref, 
            1 AS section_id, 
            total_fee, 
            term, 
            description, 
            session_year
        FROM Islamic_Fee_Structures
        WHERE session_year = ? ${termClause}
        UNION
        SELECT 
            structure_id, 
            western_class_id AS class_ref, 
            2 AS section_id, 
            total_fee, 
            term, 
            description, 
            session_year
        FROM Western_Fee_Structures
        WHERE session_year = ? ${termClause}
    `;

    const finalParams = term ? [session, parseInt(term), session, parseInt(term)] : [session, session];

    db.query(query, finalParams, (err, results) => {
        if (err) {
            console.error('Error fetching fee structures:', err);
            return res.status(500).json({ success: false, message: 'Database error.', error: err.message });
        }
        res.json({ success: true, data: results });
    });
});

// POST set fee structure + auto-create Student_Fees
app.post('/api/fees/set', (req, res) => {
    if (!req.session.isAuthenticated) {
        return res.status(401).json({ success: false, message: 'Unauthorized.' });
    }

    const { section_id, class_ref, total_fee, term, description, session_year } = req.body;

    if (!section_id || !class_ref || !total_fee || !term || !session_year) {
        return res.status(400).json({ success: false, message: 'Missing required fields.' });
    }

    db.beginTransaction(err => {
        if (err) return res.status(500).json({ success: false, message: 'Transaction error.' });

        const feeTable = section_id === 1 ? 'Islamic_Fee_Structures' : 'Western_Fee_Structures';
        const classColumn = section_id === 1 ? 'class_id' : 'western_class_id';

        const insertFeeQuery = `
            INSERT INTO ${feeTable} (${classColumn}, term, total_fee, description, session_year)
            VALUES (?, ?, ?, ?, ?)
            ON DUPLICATE KEY UPDATE
                total_fee = VALUES(total_fee),
                description = VALUES(description)
        `;

        db.query(insertFeeQuery, [class_ref, term, total_fee, description || null, session_year], (err, result) => {
            if (err) {
                return db.rollback(() => {
                    console.error('Error saving fee structure:', err);
                    res.status(500).json({ success: false, message: 'Failed to save fee structure.' });
                });
            }

            const structure_id = result.insertId || null;

            // Get structure_id if not new
            if (!structure_id) {
                const getIdQuery = `SELECT structure_id FROM ${feeTable} WHERE ${classColumn} = ? AND term = ? AND session_year = ?`;
                db.query(getIdQuery, [class_ref, term, session_year], (err, rows) => {
                    if (err || !rows.length) return db.rollback(() => res.status(500).json({ success: false }));
                    upsertStudentFees(rows[0].structure_id);
                });
            } else {
                upsertStudentFees(structure_id);
            }

            function upsertStudentFees(structure_id) {
                const upsertQuery = `
                    INSERT INTO Student_Fees (enrollment_id, structure_id, section_id, total_fee, session_year)
                    SELECT se.enrollment_id, ?, ?, ?, ?
                    FROM Student_Enrollments se
                    WHERE se.section_id = ? AND se.class_ref = ? AND se.term = ?
                    ON DUPLICATE KEY UPDATE
                        total_fee = VALUES(total_fee),
                        structure_id = VALUES(structure_id),
                        updated_date = CURRENT_TIMESTAMP
                `;

                db.query(upsertQuery, [structure_id, section_id, total_fee, session_year, section_id, class_ref, term], err => {
                    if (err) {
                        return db.rollback(() => {
                            console.error('Error updating Student_Fees:', err);
                            res.status(500).json({ success: false, message: 'Failed to update student fees.' });
                        });
                    }

                    db.commit(err => {
                        if (err) return db.rollback(() => res.status(500).json({ success: false }));
                        res.json({ success: true, message: 'Fee structure and student fees updated.' });
                    });
                });
            }
        });
    });
});

// GET payment tracking (supports session, term, class filters)
app.get('/api/fees/payments', (req, res) => {
    if (!req.session.isAuthenticated) {
        return res.status(401).json({ success: false, message: 'Unauthorized.' });
    }

    const { session, term, class: classValue, student_id } = req.query;
    if (!session) {
        return res.status(400).json({ success: false, message: 'Session year is required.' });
    }

    let query = `
        SELECT 
            sf.student_fee_id,
            s.id AS student_id,
            s.full_name AS student_name,
            s.student_id AS admission_no,
            s.guardian_phone,
            se.section_id,
            se.class_ref,
            sf.total_fee,
            COALESCE(SUM(p.payment_amount), 0) AS amount_paid,
            sf.total_fee - COALESCE(SUM(p.payment_amount), 0) AS remaining_amount,
            CASE WHEN sf.total_fee - COALESCE(SUM(p.payment_amount), 0) <= 0 THEN 'Completed' ELSE 'Pending' END AS status
        FROM Student_Fees sf
        JOIN Student_Enrollments se ON sf.enrollment_id = se.enrollment_id
        JOIN Students s ON se.student_id = s.id
        LEFT JOIN Student_Fee_Payments p 
            ON p.student_fee_id = sf.student_fee_id
            AND p.session_year = ?
            ${term ? 'AND p.term = ?' : ''}
        WHERE sf.session_year = ?
    `;

    const params = [session];
    if (term) params.push(parseInt(term));
    params.push(session);

    if (classValue) {
        const [section_id, class_ref] = classValue.split(':').map(Number);
        query += ` AND se.section_id = ? AND se.class_ref = ?`;
        params.push(section_id, class_ref);
    }

    if (student_id) {
        query += ` AND s.id = ?`;
        params.push(parseInt(student_id));
    }

    query += ` GROUP BY sf.student_fee_id ORDER BY s.full_name`;

    db.query(query, params, (err, results) => {
        if (err) {
            console.error('Error fetching payments:', err);
            return res.status(500).json({ success: false, message: 'Database error.', error: err.message });
        }
        res.json({ success: true, data: results });
    });
});

// POST add payment (creates Student_Fees if missing)
app.post('/api/fees/payments', (req, res) => {
    if (!req.session.isAuthenticated) {
        return res.status(401).json({ success: false, message: 'Unauthorized.' });
    }

    const {
        student_fee_id, payment_amount, payment_method, notes,
        term, session_year, class_ref, section_id,
        student_name, total_fee, remaining_amount
    } = req.body;

    if (!payment_amount || payment_amount <= 0 || !term || !session_year || !class_ref || !section_id) {
        return res.status(400).json({ success: false, message: 'Missing required fields.' });
    }

    db.beginTransaction(async err => {
        if (err) return res.status(500).json({ success: false });

        try {
            // 1. Verify session
            const [sess] = await queryPromise(`SELECT session_year FROM Sessions WHERE session_year = ?`, [session_year]);
            if (!sess) throw new Error('Invalid session');

            let feeId = student_fee_id;

            // 2. If no student_fee_id → create Student_Fees
            if (!feeId) {
                const [enrollment] = await queryPromise(`
                    SELECT enrollment_id FROM Student_Enrollments 
                    WHERE student_id = (SELECT id FROM Students WHERE student_id = ?)
                    AND section_id = ? AND class_ref = ? AND term = ?
                `, [req.body.student_admission || '', section_id, class_ref, term]);

                if (!enrollment) throw new Error('Student not enrolled in this term');

                // Get structure_id
                const table = section_id === 1 ? 'Islamic_Fee_Structures' : 'Western_Fee_Structures';
                const col = section_id === 1 ? 'class_id' : 'western_class_id';
                const [structure] = await queryPromise(`
                    SELECT structure_id FROM ${table} 
                    WHERE ${col} = ? AND term = ? AND session_year = ?
                `, [class_ref, term, session_year]);

                if (!structure) throw new Error('Fee structure not set');

                const [insertRes] = await queryPromise(`
                    INSERT INTO Student_Fees (enrollment_id, structure_id, section_id, total_fee, session_year, amount_paid, remaining_amount, status)
                    VALUES (?, ?, ?, ?, ?, 0, ?, 'Pending')
                `, [enrollment.enrollment_id, structure.structure_id, section_id, total_fee || 0, session_year, total_fee || 0]);

                feeId = insertRes.insertId;
            }

            // 3. Insert payment
            await queryPromise(`
                INSERT INTO Student_Fee_Payments 
                (student_fee_id, payment_amount, payment_method, notes, payment_date, term, session_year, class_ref, section_id)
                VALUES (?, ?, ?, ?, CURDATE(), ?, ?, ?, ?)
            `, [feeId, payment_amount, payment_method || null, notes || null, term, session_year, class_ref, section_id]);

            // 4. Update Student_Fees
            const [fee] = await queryPromise(`
                SELECT total_fee, amount_paid FROM Student_Fees WHERE student_fee_id = ?
            `, [feeId]);

            const newPaid = (fee.amount_paid || 0) + payment_amount;
            const newRemaining = fee.total_fee - newPaid;
            const status = newRemaining <= 0 ? 'Completed' : 'Pending';

            await queryPromise(`
                UPDATE Student_Fees 
                SET amount_paid = ?, remaining_amount = ?, status = ?
                WHERE student_fee_id = ?
            `, [newPaid, newRemaining, status, feeId]);

            // 5. Return data for receipt
            const [payment] = await queryPromise(`
                SELECT * FROM Student_Fee_Payments WHERE student_fee_id = ? ORDER BY payment_id DESC LIMIT 1
            `, [feeId]);

            db.commit(err => {
                if (err) throw err;
                res.json({
                    success: true,
                    data: {
                        student_fee_id: feeId,
                        payment_amount,
                        total_fee: fee.total_fee,
                        remaining_amount: newRemaining,
                        student_name: student_name || 'N/A',
                        session_year,
                        term,
                        class_ref,
                        section_id,
                        payment_method: payment_method || 'N/A',
                        notes: notes || 'None'
                    }
                });
            });
        } catch (error) {
            db.rollback(() => {
                console.error('Payment error:', error);
                res.status(500).json({ success: false, message: error.message || 'Payment failed' });
            });
        }
    });
});

// Helper: Promise wrapper for db.query
function queryPromise(sql, params) {
    return new Promise((resolve, reject) => {
        db.query(sql, params, (err, results) => {
            if (err) return reject(err);
            resolve(results);
        });
    });
}
// Modal instance for Payment
const paymentModal = new bootstrap.Modal(document.getElementById("addPaymentModal"))

// Global cache for classMap
let classMap = {}

// --- Utility: safe number format
function fmt(num) {
  if (num === null || num === undefined || Number.isNaN(Number(num))) return "0.00"
  return Number(num).toFixed(2)
}

// --- Attempt to get school info from DOM or provided values ---
const schoolInfo = {
  name: "Ibadurrahman College",
  address:
    "No. 1968 A, Gwammaja Housing Estate, Audu Wawu Street, opp. Ihya'ussunnah Juma'a Mosque, Dala L.G.A, Kano State, Nigeria.",
  phone: "08033459721, 09062171496",
  email: "info@irc.com.ng",
  logoSrc: "assets/images/logo.jpeg", // Provided logo source
}

// Populate terms (1, 2, 3)
async function populateTerms(target = "all") {
  console.log("Populating terms for target:", target)
  try {
    const feesTermFilter = document.getElementById("feesTermFilter")
    const paymentTerm = document.getElementById("paymentTerm")
    const feeOverviewTermFilter = document.getElementById("feeOverviewTermFilter")

    // Clear existing options
    if (target === "all" || target === "fees") {
      if (feesTermFilter)
        feesTermFilter.innerHTML = `<option value="" data-translate="allTerms">${translations[currentLang].allTerms || "All Terms"}</option>`
      if (feeOverviewTermFilter)
        feeOverviewTermFilter.innerHTML = `<option value="" data-translate="allTerms">${translations[currentLang].allTerms || "All Terms"}</option>`
    }
    if (target === "all" || target === "payment") {
      if (paymentTerm)
        paymentTerm.innerHTML = `<option value="" data-translate="selectTerm">${translations[currentLang].selectTerm || "Select Term"}</option>`
    }

    // Add term options (1, 2, 3)
    const terms = [1, 2, 3]
    terms.forEach((term) => {
      const option = document.createElement("option")
      option.value = term
      option.textContent = `Term ${term}`

      if (target === "all" || target === "fees") {
        if (feesTermFilter) feesTermFilter.appendChild(option.cloneNode(true))
        if (feeOverviewTermFilter) feeOverviewTermFilter.appendChild(option.cloneNode(true))
      }
      if (target === "all" || target === "payment") {
        if (paymentTerm) paymentTerm.appendChild(option.cloneNode(true))
      }
    })

    translatePage(currentLang)
  } catch (err) {
    console.error("Error populating terms:", err)
  }
}

// Populate sessions from database
async function populateSessions(target = "all") {
  console.log("Populating sessions for target:", target)
  try {
    const response = await fetchData("/api/sessions")
    if (!response.success) {
      console.error("Failed to fetch sessions:", response.message)
      showMessageModal("error", translations[currentLang].sessionRequired)
      return
    }

    const sessionSelect = document.getElementById("sessionSelect")
    const feesSessionFilter = document.getElementById("feesSessionFilter")
    const paymentSession = document.getElementById("paymentSession")
    const feeOverviewSessionFilter = document.getElementById("feeOverviewSessionFilter")

if (target === "all" || target === "fees") {
  if (sessionSelect)
    sessionSelect.innerHTML = `<option value="" data-translate="selectSession">${translations[currentLang].selectSession}</option>`;
  
  // Removed "All Sessions" default option
  if (feesSessionFilter)
    feesSessionFilter.innerHTML = ""; 
  
  // Removed "All Sessions" default option
  if (feeOverviewSessionFilter)
    feeOverviewSessionFilter.innerHTML = "";
}

if (target === "all" || target === "payment") {
  if (paymentSession)
    paymentSession.innerHTML = `<option value="" data-translate="selectSession">${translations[currentLang].selectSession}</option>`;
}

response.data.forEach((session) => {
  const option = document.createElement("option");
  option.value = session.session_year;
  option.textContent = session.session_year;
  if (session.is_current) option.setAttribute("selected", "selected");

  if (target === "all" || target === "fees") {
    if (sessionSelect) sessionSelect.appendChild(option.cloneNode(true));
    if (feesSessionFilter) feesSessionFilter.appendChild(option.cloneNode(true));
    if (feeOverviewSessionFilter) feeOverviewSessionFilter.appendChild(option.cloneNode(true));
  }
  if (target === "all" || target === "payment") {
    if (paymentSession) paymentSession.appendChild(option.cloneNode(true));
  }
});

translatePage(currentLang);
} catch (err) {
  console.error("Error fetching sessions:", err);
  showMessageModal("error", translations[currentLang].sessionRequired);
}
}
// Add this AFTER populateSessions() is called (e.g., in your init function)
document.getElementById('feesSessionFilter')?.addEventListener('change', async function () {
    const session = this.value; // "" means "All Sessions"
    await loadPaymentTracking(session);
});

// Load payment tracking with session filter
async function loadPaymentTracking(session = '') {
    const tableBody = document.getElementById('paymentTableBody');
    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';

    let url = '/api/fees/payments';
    if (session && session !== '') {
        url += `?session=${encodeURIComponent(session)}`;
    }
    // If session === '', send no param → backend should return all

    const result = await fetchData(url);

    if (result.success && result.data) {
        renderPaymentTable(result.data);
    } else {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">' + 
            (translations[currentLang].noRecordsFound || 'No records found.') + 
            '</td></tr>';
        if (result.message) {
            showMessageModal('error', result.message);
        }
    }
}
// Populate classes
async function populateClasses(staff = null, student = null, target = "all") {
  console.log("Populating classes for target:", target)
  const data = await fetchData("/api/classes")
  if (!data.success) {
    console.error("Failed to fetch classes:", data.message)
    showMessageModal("error", translations[currentLang].classRequired)
    return
  }

  classMap = {}
  data.data.forEach((cls) => {
    classMap[`${cls.section_id}:${cls.id}`] = cls.name
  })

  const formMasterSelect = document.getElementById("formMasterClass")
  const classesTaughtSelect = document.getElementById("classesTaught")
  const studentClassesSelect = document.getElementById("studentClasses")
  const studentClassFilter = document.getElementById("studentClassFilter")
  const feesClassSelect = document.getElementById("classSelect")
  const trackClassSelect = document.getElementById("trackClassSelect")
  const paymentClassSelect = document.getElementById("paymentClassSelect")

  if (target === "all" || target === "staff-student") {
    if (formMasterSelect)
      formMasterSelect.innerHTML = `<option value="" data-translate="selectClass">${translations[currentLang].selectClass}</option>`
    if (classesTaughtSelect) classesTaughtSelect.innerHTML = ""
    if (studentClassesSelect) studentClassesSelect.innerHTML = ""
    if (studentClassFilter)
      studentClassFilter.innerHTML = `<option value="" data-translate="allClasses">${translations[currentLang].allClasses}</option>`
  }
  if (target === "all" || target === "fees") {
    if (feesClassSelect)
      feesClassSelect.innerHTML = `<option value="" data-translate="selectClass">${translations[currentLang].selectClass}</option>`
    if (trackClassSelect)
      trackClassSelect.innerHTML = `<option value="" data-translate="allClasses">${translations[currentLang].allClasses}</option>`
    if (paymentClassSelect)
      paymentClassSelect.innerHTML = `<option value="" data-translate="selectClass">${translations[currentLang].selectClass}</option>`
  }

  const islamicGroup = document.createElement("optgroup")
  islamicGroup.label = translations[currentLang].basicClass || "Islamic Classes"
  const westernGroup = document.createElement("optgroup")
  westernGroup.label = translations[currentLang].mediumClass || "Western Classes"

  data.data.forEach((cls) => {
    const value = `${cls.section_id}:${cls.id}`
    const option = document.createElement("option")
    option.value = value
    option.textContent = cls.name

    if (target === "all" || target === "staff-student") {
      if (formMasterSelect) formMasterSelect.appendChild(option.cloneNode(true))
      if (classesTaughtSelect) classesTaughtSelect.appendChild(option.cloneNode(true))
      if (studentClassFilter) studentClassFilter.appendChild(option.cloneNode(true))
      if (cls.section_id === 1) {
        islamicGroup.appendChild(option.cloneNode(true))
      } else {
        westernGroup.appendChild(option.cloneNode(true))
      }
    }
    if (target === "all" || target === "fees") {
      if (feesClassSelect) feesClassSelect.appendChild(option.cloneNode(true))
      if (trackClassSelect) trackClassSelect.appendChild(option.cloneNode(true))
      if (paymentClassSelect) paymentClassSelect.appendChild(option.cloneNode(true))
    }
  })

  if (target === "all" || target === "staff-student") {
    if (studentClassesSelect) {
      studentClassesSelect.appendChild(islamicGroup)
      studentClassesSelect.appendChild(westernGroup)
    }
  }

  if (staff?.classes?.length && (target === "all" || target === "staff-student")) {
    staff.classes.forEach((cls) => {
      const value = `${cls.section_id}:${cls.class_id}`
      const opt = classesTaughtSelect?.querySelector(`option[value="${value}"]`)
      if (opt) opt.selected = true
    })
  }

  if (staff?.formMaster && (target === "all" || target === "staff-student")) {
    const value = `${staff.formMaster.section_id}:${staff.formMaster.class_id}`
    const opt = formMasterSelect?.querySelector(`option[value="${value}"]`)
    if (opt) opt.selected = true
  }

  if (student?.classes?.length && (target === "all" || target === "staff-student")) {
    student.classes.forEach((clsValue) => {
      const opt = studentClassesSelect?.querySelector(`option[value="${clsValue}"]`)
      if (opt) opt.selected = true
    })
    studentClassesSelect?.dispatchEvent(new Event("change"))
  }

  translatePage(currentLang)
}
document.addEventListener("DOMContentLoaded", () => {
  const classSelect = document.getElementById("paymentClassSelect");
  const termSelect = document.getElementById("paymentTerm");
  const sessionSelect = document.getElementById("paymentSession");

  // When class, term, or session changes, re-fetch students
  if (classSelect) {
    classSelect.addEventListener("change", () => {
      populateStudentSelect(classSelect.value);
    });
  }

  if (termSelect) {
    termSelect.addEventListener("change", () => {
      const classVal = classSelect?.value;
      if (classVal) populateStudentSelect(classVal);
    });
  }

  if (sessionSelect) {
    sessionSelect.addEventListener("change", () => {
      const classVal = classSelect?.value;
      if (classVal) populateStudentSelect(classVal);
    });
  }
});


// Populate student select based on class
async function populateStudentSelect(classValue) {
  const studentSelect = document.getElementById("paymentStudentSelect")
  if (!studentSelect) return

  studentSelect.innerHTML = `<option value="" data-translate="selectStudent">${translations[currentLang].selectStudent}</option>`
  if (!classValue) return

  try {
    const [section_id, class_id] = classValue.split(":").map(Number)
    const sessionValue = document.getElementById("paymentSession")?.value
    const termValue = document.getElementById("paymentTerm")?.value

    let queryParams = `class=${section_id}:${class_id}`
    if (sessionValue) queryParams += `&session=${encodeURIComponent(sessionValue)}`
    if (termValue) queryParams += `&term=${termValue}`

    const response = await fetchData(`/api/students/by-class?${queryParams}`)
    if (response.success) {
      response.data.forEach((student) => {
        const option = document.createElement("option")
        option.value = student.student_fee_id || student.id
        option.textContent = `${student.name} (${student.admission_no})`
        option.dataset.studentName = student.name
        option.dataset.totalFee = student.total_fee
        option.dataset.remainingAmount = student.remaining_amount
        studentSelect.appendChild(option)
      })
      translatePage(currentLang)
    } else {
      console.error("Failed to fetch students:", response.message)
      showMessageModal("error", translations[currentLang].studentRequired)
    }
  } catch (err) {
    console.error("Error fetching students:", err)
    showMessageModal("error", translations[currentLang].studentRequired)
  }
}

// Fetch payment data
async function fetchPaymentData() {
  console.log("Fetching payment data")
  const classValue = document.getElementById("trackClassSelect")?.value
  const termValue = document.getElementById("feesTermFilter")?.value || ""
  const sessionValue = document.getElementById("feesSessionFilter")?.value || ""
  const searchQuery = document.getElementById("paymentSearch")?.value || ""

  let queryParams = ""
  if (termValue) queryParams += `term=${termValue}`
  if (sessionValue) queryParams += `${queryParams ? "&" : ""}session=${encodeURIComponent(sessionValue)}`
  if (classValue) queryParams += `${queryParams ? "&" : ""}class=${encodeURIComponent(classValue)}`
  if (queryParams) queryParams = `?${queryParams}`

  try {
    const response = await fetchData(`/api/fees/payments${queryParams}`)
    if (response.success) {
      console.log("Payment data fetched:", response.data)
      await renderPaymentTable(response.data, searchQuery)
    } else {
      console.error("Failed to fetch payment data:", response.message)
      showMessageModal("error", translations[currentLang].requiredFieldsError)
    }
  } catch (err) {
    console.error("Error fetching payment data:", err)
    showMessageModal("error", translations[currentLang].requiredFieldsError)
  }
}

// Fetch fee structure overview data
async function fetchFeeStructureOverview() {
  console.log("Fetching fee structure overview")
  const termValue = document.getElementById("feeOverviewTermFilter")?.value || ""
  const sessionValue = document.getElementById("feeOverviewSessionFilter")?.value || ""

  if (!sessionValue) {
    showMessageModal("error", translations[currentLang].sessionRequired)
    return
  }

  let queryParams = `session=${encodeURIComponent(sessionValue)}`
  if (termValue) queryParams += `&term=${termValue}`

  try {
    const response = await fetchData(`/api/fees/structures?${queryParams}`)
    if (response.success) {
      console.log("Fee structure data fetched:", response.data)
      await renderFeeStructureTable(response.data)
    } else {
      console.error("Failed to fetch fee structure data:", response.message)
      showMessageModal("error", translations[currentLang].requiredFieldsError)
    }
  } catch (err) {
    console.error("Error fetching fee structure data:", err)
    showMessageModal("error", translations[currentLang].requiredFieldsError)
  }
}

// Render payment table
async function renderPaymentTable(feeData, searchQuery = "") {
  const tableBody = document.getElementById("paymentTableBody")
  if (!tableBody) {
    console.error("Payment table body not found")
    return
  }
  tableBody.innerHTML = ""

  if (!feeData || feeData.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="7" class="text-center" data-translate="noRecordsFound">${translations[currentLang].noRecordsFound}</td></tr>`
    return
  }

  const filteredData = feeData.filter((fee) => {
    const searchStr = `${fee.student_name || ""} ${fee.student_id || ""}`.toLowerCase()
    return !searchQuery || searchStr.includes(searchQuery.toLowerCase())
  })

  filteredData.forEach((fee) => {
    const classDisplay = classMap[`${fee.section_id}:${fee.class_ref}`] || "N/A"
    const row = document.createElement("tr")
    row.innerHTML = `
            <td>${fee.student_name || "N/A"}</td>
            <td>${classDisplay}</td>
            <td>${fee.guardian_phone || "N/A"}</td>
            <td>${fmt(fee.total_fee)}</td>
            <td>${fmt(fee.amount_paid)}</td>
            <td>${fmt(fee.remaining_amount)}</td>
            <td><span class="badge ${fee.status === "Completed" ? "bg-success" : "bg-warning"}">${fee.status || "N/A"}</span></td>
        `
    tableBody.appendChild(row)
  })

  translatePage(currentLang)
}

// Render fee structure overview table
async function renderFeeStructureTable(feeData) {
  const tableBody = document.getElementById("feeStructureTableBody")
  if (!tableBody) {
    console.error("Fee structure table body not found")
    return
  }
  tableBody.innerHTML = ""

  if (!feeData || feeData.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center" data-translate="noRecordsFound">${translations[currentLang].noRecordsFound}</td></tr>`
    return
  }

  feeData.forEach((fee) => {
    const classDisplay = classMap[`${fee.section_id}:${fee.class_ref}`] || "N/A"
    const row = document.createElement("tr")
    row.innerHTML = `
            <td>${classDisplay}</td>
            <td>${fee.section_id === 1 ? "Islamic" : "Western"}</td>
            <td>${fee.term}</td>
            <td>₦${fmt(fee.total_fee)}</td>
            <td>${fee.description || "N/A"}</td>
        `
    tableBody.appendChild(row)
  })

  translatePage(currentLang)
}

// Prepare payment table for export
async function preparePaymentTableForExport() {
  const classValue = document.getElementById("trackClassSelect")?.value
  const termValue = document.getElementById("feesTermFilter")?.value || ""
  const sessionValue = document.getElementById("feesSessionFilter")?.value || ""
  const searchQuery = document.getElementById("paymentSearch")?.value || ""

  let queryParams = ""
  if (termValue) queryParams += `term=${termValue}`
  if (sessionValue) queryParams += `${queryParams ? "&" : ""}session=${encodeURIComponent(sessionValue)}`
  if (classValue) queryParams += `${queryParams ? "&" : ""}class=${encodeURIComponent(classValue)}`
  if (queryParams) queryParams = `?${queryParams}`

  const feeResp = await fetchData(`/api/fees/payments${queryParams}`)
  const table = document.createElement("table")
  table.setAttribute("id", "paymentsExportTable")
  table.classList.add("table", "table-sm")

  const thead = table.createTHead()
  const tbody = table.createTBody()
  const headers = [
    translations[currentLang].studentName,
    translations[currentLang].class,
    translations[currentLang].guardianPhone,
    translations[currentLang].totalFee,
    translations[currentLang].amountPaid,
    translations[currentLang].remainingAmount,
    translations[currentLang].status,
  ]
  const headerRow = thead.insertRow()
  headers.forEach((header) => {
    const th = document.createElement("th")
    th.textContent = header
    headerRow.appendChild(th)
  })

  if (feeResp.success && Array.isArray(feeResp.data)) {
    const filteredData = feeResp.data.filter((fee) => {
      const searchStr = `${fee.student_name || ""} ${fee.student_id || ""}`.toLowerCase()
      return !searchQuery || searchStr.includes(searchQuery.toLowerCase())
    })

    filteredData.forEach((fee) => {
      const classDisplay = classMap[`${fee.section_id}:${fee.class_ref}`] || "N/A"
      const row = tbody.insertRow()
      row.insertCell().textContent = fee.student_name || "N/A"
      row.insertCell().textContent = classDisplay
      row.insertCell().textContent = fee.guardian_phone || "N/A"
      row.insertCell().textContent = fmt(fee.total_fee)
      row.insertCell().textContent = fmt(fee.amount_paid)
      row.insertCell().textContent = fmt(fee.remaining_amount)
      row.insertCell().textContent = fee.status || "N/A"
    })
  } else {
    console.warn("preparePaymentTableForExport: no data or unexpected response", feeResp)
  }

  return table
}

// Prepare fee structure table for export
async function prepareFeeStructureTableForExport() {
  const termValue = document.getElementById("feeOverviewTermFilter")?.value || ""
  const sessionValue = document.getElementById("feeOverviewSessionFilter")?.value || ""

  let queryParams = `session=${encodeURIComponent(sessionValue)}`
  if (termValue) queryParams += `&term=${termValue}`

  const feeResp = await fetchData(`/api/fees/structures?${queryParams}`)
  const table = document.createElement("table")
  table.setAttribute("id", "feeStructureExportTable")
  table.classList.add("table", "table-sm")

  const thead = table.createTHead()
  const tbody = table.createTBody()
  const headers = [
    translations[currentLang].class,
    translations[currentLang].section,
    translations[currentLang].term,
    translations[currentLang].totalFee,
    translations[currentLang].description,
  ]
  const headerRow = thead.insertRow()
  headers.forEach((header) => {
    const th = document.createElement("th")
    th.textContent = header
    headerRow.appendChild(th)
  })

  if (feeResp.success && Array.isArray(feeResp.data)) {
    feeResp.data.forEach((fee) => {
      const classDisplay = classMap[`${fee.section_id}:${fee.class_ref}`] || "N/A"
      const row = tbody.insertRow()
      row.insertCell().textContent = classDisplay
      row.insertCell().textContent = fee.section_id === 1 ? "Islamic" : "Western"
      row.insertCell().textContent = fee.term
      row.insertCell().textContent = `₦${fmt(fee.total_fee)}`
      row.insertCell().textContent = fee.description || "N/A"
    })
  } else {
    console.warn("prepareFeeStructureTableForExport: no data or unexpected response", feeResp)
  }

  return table
}

// Export fee structure to PDF
async function exportFeeStructureToPDF() {
  try {
    const doc = new jsPDF()
    const marginLeft = 10
    let y = 10

    // Logo if available
    const logoSrc = schoolInfo.logoSrc
    if (logoSrc) {
      try {
        const img = await loadImageAsDataURL(logoSrc)
        if (img) doc.addImage(img, "JPEG", marginLeft, y, 30, 30)
      } catch (err) {
        console.warn("Failed to add logo to PDF:", err)
      }
    }

    // School text
    doc.setFontSize(12)
    doc.text(schoolInfo.name, marginLeft + 40, y + 8)
    doc.setFontSize(7)
    doc.text(schoolInfo.address, marginLeft + 40, y + 15)
    doc.text(`${schoolInfo.phone} | ${schoolInfo.email}`, marginLeft + 40, y + 22)

    y += 36
    doc.setFontSize(11)
    doc.text(translations[currentLang].feeStructureOverview || "Fee Structure Overview", marginLeft, y)
    y += 4

    // Table
    const table = await prepareFeeStructureTableForExport()
    doc.autoTable({
      html: table,
      startY: y + 6,
      styles: { fontSize: 8 },
      headStyles: { fillColor: [66, 133, 244] },
      bodyStyles: { textColor: [0, 0, 0] },
      theme: "striped",
    })

    doc.save(`fee_structure_${Date.now()}.pdf`)
  } catch (err) {
    console.error("Error exporting fee structure to PDF:", err)
    showMessageModal("error", translations[currentLang].requiredFieldsError)
  }
}

// Export fee structure to Excel
async function exportFeeStructureToExcel() {
  try {
    const table = await prepareFeeStructureTableForExport()
    const workbook = XLSX.utils.table_to_book(table, { sheet: "Fee Structure" })
    XLSX.writeFile(workbook, `fee_structure_${Date.now()}.xlsx`)
  } catch (err) {
    console.error("Error exporting fee structure to Excel:", err)
    showMessageModal("error", translations[currentLang].requiredFieldsError)
  }
}

// --- Export to PDF (Payments) ---
async function exportPaymentsToPDF() {
  try {
    const doc = new jsPDF()
    // header
    const marginLeft = 10
    let y = 10

    // Logo if available
    const logoSrc = schoolInfo.logoSrc
    if (logoSrc) {
      try {
        const img = await loadImageAsDataURL(logoSrc)
        if (img) doc.addImage(img, "JPEG", marginLeft, y, 30, 30)
      } catch (err) {
        console.warn("Failed to add logo to PDF:", err)
      }
    }

    // School text
    doc.setFontSize(12)
    doc.text(schoolInfo.name, marginLeft + 40, y + 8)
    doc.setFontSize(7)
    doc.text(schoolInfo.address, marginLeft + 40, y + 15)
    doc.text(`${schoolInfo.phone} | ${schoolInfo.email}`, marginLeft + 40, y + 22)

    y += 36
    doc.setFontSize(11)
    doc.text(translations[currentLang].paymentTracking || "Payments Tracking", marginLeft, y)
    y += 4

    // Table
    const table = await preparePaymentTableForExport()
    doc.autoTable({
      html: table,
      startY: y + 6,
      styles: { fontSize: 8 },
      headStyles: { fillColor: [66, 133, 244] },
      bodyStyles: { textColor: [0, 0, 0] },
      theme: "striped",
    })

    doc.save(`payments_${Date.now()}.pdf`)
  } catch (err) {
    console.error("Error exporting payments to PDF:", err)
    showMessageModal("error", translations[currentLang].requiredFieldsError)
  }
}

// helper: load image and convert to dataURL (attempt; might fail due to CORS)
async function loadImageAsDataURL(url) {
  return new Promise((resolve, reject) => {
    const img = new Image()
    img.crossOrigin = "Anonymous"
    img.onload = () => {
      try {
        const canvas = document.createElement("canvas")
        canvas.width = img.width
        canvas.height = img.height
        const ctx = canvas.getContext("2d")
        ctx.drawImage(img, 0, 0)
        const dataURL = canvas.toDataURL("image/jpeg")
        resolve(dataURL)
      } catch (err) {
        reject(err)
      }
    }
    img.onerror = (err) => {
      reject(err)
    }
    img.src = url
  })
}

// --- Export to Excel (Payments) ---
async function exportPaymentsToExcel() {
  try {
    const table = await preparePaymentTableForExport()
    const workbook = XLSX.utils.table_to_book(table, { sheet: "Payments" })
    XLSX.writeFile(workbook, `payments_${Date.now()}.xlsx`)
  } catch (err) {
    console.error("Error exporting payments to Excel:", err)
    showMessageModal("error", translations[currentLang].requiredFieldsError)
  }
}

// --- Generate Payment Receipt PDF (called after successful payment) ---
async function generatePaymentReceipt(paymentResponseData, fallbackFormData = null) {
  try {
    const doc = new jsPDF()
    const marginLeft = 12
    let y = 12

    // Logo if available
    const logoSrc = schoolInfo.logoSrc
    if (logoSrc) {
      try {
        const img = await loadImageAsDataURL(logoSrc)
        if (img) doc.addImage(img, "JPEG", marginLeft, y, 28, 28)
      } catch (err) {
        console.warn("Failed to add logo to PDF:", err)
      }
    }

    // School info
    doc.setFontSize(13)
    doc.text(schoolInfo.name, marginLeft + 36, y + 8)
    doc.setFontSize(7)
    doc.text(schoolInfo.address, marginLeft + 36, y + 14)
    doc.text(`${schoolInfo.phone} | ${schoolInfo.email}`, marginLeft + 36, y + 20)

    // Title
    doc.setFontSize(14)
    doc.text("STUDENT PAYMENT RECEIPT", 105, y + 36, null, null, "center")

    y += 40 // Adjust starting position after title

    // Payment data source priority:
    // 1. paymentResponseData (if it looks like an object with fields)
    // 2. fallbackFormData (the data we sent when creating payment)
    const pd = { ...(fallbackFormData || {}), ...(paymentResponseData || {}) }

    // Try to infer student name from selected option if not provided
    if (!pd.student_name) {
      const sel = document.getElementById("paymentStudentSelect")
      const opt = sel?.selectedOptions?.[0]
      if (opt) pd.student_name = opt.dataset.studentName || opt.textContent || "N/A"
    }

    // Compose a small table-like layout
    doc.setFontSize(10)
    const leftX = marginLeft
    let lineY = y
    const lineHeight = 7

    const safe = (val) => (val === null || val === undefined ? "N/A" : String(val))

    doc.text(`Date: ${new Date().toLocaleString("en-US", { timeZone: "Africa/Lagos" })}`, leftX, lineY)
    lineY += lineHeight
    doc.text(`Student: ${safe(pd.student_name)}`, leftX, lineY)
    lineY += lineHeight
    doc.text(`Session: ${safe(pd.session_year)}`, leftX, lineY)
    lineY += lineHeight
    doc.text(`Term: ${safe(pd.term)}`, leftX, lineY)
    lineY += lineHeight
    doc.text(`Class: ${classMap[`${pd.section_id}:${pd.class_ref}`] || "N/A"}`, leftX, lineY)
    lineY += lineHeight
    doc.text(`Student Fee ID: ${safe(pd.student_fee_id)}`, leftX, lineY)
    lineY += lineHeight

    // Right column (amounts, including total, this payment, and pending)
    const rightX = 120
    lineY = y
    doc.text(`Total Fee: ₦${fmt(pd.total_fee)}`, rightX, lineY)
    lineY += lineHeight
    doc.text(`Amount Paid: ₦${fmt(pd.payment_amount)}`, rightX, lineY)
    lineY += lineHeight
    doc.text(`Remaining: ₦${fmt(pd.remaining_amount)}`, rightX, lineY)
    lineY += lineHeight
    doc.text(`Payment Method: ${safe(pd.payment_method || "N/A")}`, rightX, lineY)
    lineY += lineHeight
    doc.text(`Notes: ${safe(pd.notes || "None")}`, rightX, lineY)
    lineY += lineHeight

    // Signature line (simple line)
    const sigY = lineY + 10
    doc.line(leftX, sigY, leftX + 70, sigY) // simple line
    doc.setFontSize(9)
    doc.text("Authorized Signature", leftX, sigY + 6)

    // Optional bottom border
    doc.setLineWidth(0.1)
    doc.line(10, sigY + 18, 200, sigY + 18)

    // Save
    doc.save(`Receipt_${pd.student_fee_id || "unknown"}_${Date.now()}.pdf`)
  } catch (err) {
    console.error("Error generating receipt:", err)
    showMessageModal("error", "Failed to generate receipt")
  }
}

// --- Handle set fees form submission ---
document.getElementById("setFeesForm")?.addEventListener("submit", async (e) => {
  e.preventDefault()
  console.log("Set fees form submitted")
  const classValue = document.getElementById("classSelect")?.value
  const feeAmount = document.getElementById("feeAmount")?.value
  const term = document.getElementById("termSelect")?.value
  const session = document.getElementById("sessionSelect")?.value
  const description = document.getElementById("feeDescription")?.value

  if (!classValue || !feeAmount || !term || !session) {
    console.error("Missing required fields:", { classValue, feeAmount, term, session })
    showMessageModal("error", translations[currentLang].requiredFieldsError)
    return
  }

  const [section_id, class_ref] = classValue.split(":").map(Number)
  const data = {
    section_id,
    class_ref,
    total_fee: Number.parseFloat(feeAmount),
    term: Number.parseInt(term),
    session_year: session,
    description: description || null,
  }

  try {
    const response = await fetchData("/api/fees/set", {
      method: "POST",
      body: JSON.stringify(data),
      headers: { "Content-Type": "application/json" },
    })

    if (response.success) {
      showMessageModal("success", translations[currentLang].paymentSaved)
      document.getElementById("setFeesForm").reset()
      if (document.getElementById("feeStructureOverviewTab")?.classList.contains("active")) {
        await fetchFeeStructureOverview()
      }
    } else {
      console.error("Failed to save fee structure:", response.message)
      showMessageModal("error", translations[currentLang].requiredFieldsError)
    }
  } catch (err) {
    console.error("Error saving fee structure:", err)
    showMessageModal("error", translations[currentLang].requiredFieldsError)
  }
})

// Handle top Add Payment button click
document.getElementById("topAddPaymentBtn")?.addEventListener("click", async () => {
  console.log("Top Add Payment button clicked")
  const paymentForm = document.getElementById("addPaymentForm")
  const studentSelectGroup = document.getElementById("studentSelectGroup")
  const classSelect = document.getElementById("paymentClassSelect")
  const sessionSelect = document.getElementById("paymentSession")
  const termSelect = document.getElementById("paymentTerm")

  if (paymentForm && studentSelectGroup && classSelect && sessionSelect && termSelect) {
    paymentForm.reset()
    studentSelectGroup.classList.remove("d-none")
    document.getElementById("addPaymentModalLabel").textContent = translations[currentLang].addPayment
    await populateClasses(null, null, "fees")
    await populateSessions("payment")
    await populateTerms("payment")
    classSelect.value = ""
    sessionSelect.value = ""
    termSelect.value = ""
    document.getElementById("paymentStudentSelect").innerHTML =
      `<option value="" data-translate="selectStudent">${translations[currentLang].selectStudent}</option>`
    document.getElementById("paymentTotalFee").value = ""
    document.getElementById("paymentRemaining").value = ""
    translatePage(currentLang)
    paymentModal.show()
  } else {
    console.error("Payment modal elements not found")
    showMessageModal("error", translations[currentLang].requiredFieldsError)
  }
})

// Handle class selection to populate students and fee data
document.getElementById("paymentClassSelect")?.addEventListener("change", async (e) => {
  const classValue = e.target.value
  await populateStudentSelect(classValue)
})

// Handle session and term selection to fetch fee data
async function updateFeeData() {
  const classValue = document.getElementById("paymentClassSelect")?.value
  const sessionValue = document.getElementById("paymentSession")?.value
  const termValue = document.getElementById("paymentTerm")?.value
  const studentFeeId = document.getElementById("paymentStudentSelect")?.value

  if (classValue && sessionValue && termValue) {
    await populateStudentSelect(classValue)
  }

  if (studentFeeId) {
    const studentSelect = document.getElementById("paymentStudentSelect")
    const selectedOption = studentSelect?.selectedOptions[0]
    if (selectedOption) {
      const totalFee = selectedOption.dataset.totalFee
      const remainingAmount = selectedOption.dataset.remainingAmount
      document.getElementById("paymentTotalFee").value = fmt(totalFee || 0)
      document.getElementById("paymentRemaining").value = fmt(remainingAmount || 0)
    }
  } else {
    document.getElementById("paymentTotalFee").value = ""
    document.getElementById("paymentRemaining").value = ""
  }
}

document.getElementById("paymentSession")?.addEventListener("change", updateFeeData)
document.getElementById("paymentTerm")?.addEventListener("change", updateFeeData)
document.getElementById("paymentStudentSelect")?.addEventListener("change", updateFeeData)

// Handle add payment form submission
document.getElementById("addPaymentForm")?.addEventListener("submit", async (e) => {
  e.preventDefault()
  console.log("Add payment form submitted")

  const studentFeeId = document.getElementById("paymentStudentSelect")?.value
  const paymentAmountRaw = document.getElementById("paymentAmount")?.value
  const paymentMethod = document.getElementById("paymentMethod")?.value
  const paymentNotes = document.getElementById("paymentNotes")?.value
  const term = document.getElementById("paymentTerm")?.value
  const session = document.getElementById("paymentSession")?.value
  const classValue = document.getElementById("paymentClassSelect")?.value

  if (!studentFeeId || !paymentAmountRaw || Number(paymentAmountRaw) <= 0 || !term || !session || !classValue) {
    console.error("Invalid payment data:", { studentFeeId, paymentAmountRaw, term, session, classValue })
    showMessageModal("error", translations[currentLang].requiredFieldsError)
    return
  }

  const paymentAmount = Number.parseFloat(paymentAmountRaw)
  const totalFee = Number.parseFloat(document.getElementById("paymentTotalFee")?.value) || 0
  const oldRemaining = Number.parseFloat(document.getElementById("paymentRemaining")?.value) || 0
  const opt = document.getElementById("paymentStudentSelect")?.selectedOptions[0]
  const studentName = opt?.dataset.studentName || "N/A"

  const [section_id, class_ref] = classValue.split(":").map(Number)
  const dataToSend = {
    student_fee_id: Number.parseInt(studentFeeId),
    payment_amount: paymentAmount,
    payment_method: paymentMethod || null,
    term: Number.parseInt(term),
    session_year: session,
    class_ref,
    section_id,
    notes: paymentNotes || null,
  }

  // Construct fallback before resetting form
  const fallback = {
    ...dataToSend,
    student_name: studentName,
    total_fee: totalFee,
    remaining_amount: oldRemaining - paymentAmount,
  }

  try {
    const response = await fetchData("/api/fees/payments", {
      method: "POST",
      body: JSON.stringify(dataToSend),
      headers: { "Content-Type": "application/json" },
    })

    if (response.success) {
      showMessageModal("success", translations[currentLang].paymentSaved)
      paymentModal.hide()
      document.getElementById("addPaymentForm").reset()
      // Generate a receipt: prefer response.data (if backend returns details),
      // otherwise pass the fallback we constructed
      const respData = response.data || null
      await generatePaymentReceipt(respData, fallback)
      await fetchPaymentData()
    } else {
      console.error("Failed to add payment:", response.message)
      showMessageModal("error", translations[currentLang].requiredFieldsError)
    }
  } catch (err) {
    console.error("Error adding payment:", err)
    showMessageModal("error", translations[currentLang].requiredFieldsError)
  }
})

// Handle search input, class, session, and term filter change
document.getElementById("paymentSearch")?.addEventListener("input", () => {
  fetchPaymentData()
})
document.getElementById("trackClassSelect")?.addEventListener("change", () => {
  fetchPaymentData()
})
document.getElementById("feesSessionFilter")?.addEventListener("change", () => {
  fetchPaymentData()
})
document.getElementById("feesTermFilter")?.addEventListener("change", () => {
  fetchPaymentData()
})

// Handle fee structure overview filters
document.getElementById("feeOverviewSessionFilter")?.addEventListener("change", () => {
  fetchFeeStructureOverview()
})
document.getElementById("feeOverviewTermFilter")?.addEventListener("change", () => {
  fetchFeeStructureOverview()
})

// Initialize Fees Management
async function initFeesManagement() {
  console.log("Initializing Fees Management")
  await populateClasses(null, null, "fees")
  await populateSessions("fees")
  await populateTerms("fees")
  document.getElementById("exportPaymentsPdfBtn")?.addEventListener("click", exportPaymentsToPDF)
  document.getElementById("exportPaymentsExcelBtn")?.addEventListener("click", exportPaymentsToExcel)
  document.getElementById("exportFeeStructurePdfBtn")?.addEventListener("click", exportFeeStructureToPDF)
  document.getElementById("exportFeeStructureExcelBtn")?.addEventListener("click", exportFeeStructureToExcel)
  if (document.getElementById("trackFeesTab")?.classList.contains("active")) {
    await fetchPaymentData()
  } else if (document.getElementById("feeStructureOverviewTab")?.classList.contains("active")) {
    await fetchFeeStructureOverview()
  }
}

// Run on DOM load
document.addEventListener("DOMContentLoaded", () => {
  console.log("DOM fully loaded")
  if (document.getElementById("fees-management-view")) {
    initFeesManagement()
  }
})

// Fix tab switching with Bootstrap event
document.querySelectorAll("#feesTab .nav-link").forEach((tab) => {
  tab.addEventListener("shown.bs.tab", (e) => {
    console.log(`${e.target.id} shown`)
    if (e.target.id === "trackFeesTab") {
      fetchPaymentData()
    } else if (e.target.id === "feeStructureOverviewTab") {
      fetchFeeStructureOverview()
    }
  })
})

please above are the frontend js and backend for set fee and tracking fee payment and the backend of how student is added and the enrollment and the backend for tracking fee and set feee structure they are all working is only making payment for student that is not working when i click add when i want make payment it say all fields rewuired please help me:

this is the html:
<!-- ================= FEES MANAGEMENT ================= -->
<div id="fees-management-view" style="display: none;">
    <h2 class="text-2xl font-semibold mb-4" data-translate="feesManagement">Fees Management</h2>

    <!-- Tabs + Add Payment -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <ul class="nav nav-tabs" id="feesTab">
            <li class="nav-item">
                <a class="nav-link active" id="setFeesTab" data-bs-toggle="tab" href="#setFeesSection" data-translate="setFees">Set Fees per Class</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="trackFeesTab" data-bs-toggle="tab" href="#trackFeesSection" data-translate="paymentTracking">Payment Tracking</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="feeStructureOverviewTab" data-bs-toggle="tab" href="#feeStructureOverviewSection" data-translate="feeStructureOverview">Fee Structure Overview</a>
            </li>
        </ul>
        <button class="btn btn-primary ms-3" id="topAddPaymentBtn" data-translate="addPayment">Add Payment</button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">

        <!-- ==== SET FEES ==== -->
        <div id="setFeesSection" class="tab-pane fade show active">
            <div class="bg-white p-4 rounded shadow">
                <h5 class="mb-3" data-translate="setFees">Set Fees per Class</h5>
                <form id="setFeesForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" data-translate="selectClass">Select Class</label>
                            <select id="classSelect" class="form-select" required></select>
                            <div class="invalid-feedback" data-translate="classRequired">Class is required.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" data-translate="session">Session</label>
                            <select id="sessionSelect" class="form-select" required></select>
                            <div class="invalid-feedback" data-translate="sessionRequired">Session is required.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" data-translate="term">Term</label>
                            <select id="termSelect" class="form-select" required>
                                <option value="1" data-translate="firstTerm">1st Term</option>
                                <option value="2" data-translate="secondTerm">2nd Term</option>
                                <option value="3" data-translate="thirdTerm">3rd Term</option>
                            </select>
                            <div class="invalid-feedback" data-translate="termRequired">Term is required.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" data-translate="totalFee">Amount (₦)</label>
                            <input type="number" class="form-control" id="feeAmount" min="0" step="0.01" required>
                            <div class="invalid-feedback" data-translate="amountRequired">Amount required.</div>
                        </div>
                        <div class="col-12">
                            <label class="form-label" data-translate="notes">Description (Optional)</label>
                            <textarea class="form-control" id="feeDescription" rows="2"></textarea>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-success w-100" data-translate="saveFees">Save Fee</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- ==== PAYMENT TRACKING ==== -->
        <div id="trackFeesSection" class="tab-pane fade">
            <div class="bg-white p-4 rounded shadow">
                <h5 class="mb-3" data-translate="paymentTracking">Payment Tracking</h5>

                <!-- Filters -->
                <div class="row g-2 mb-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="paymentSearch" placeholder="Name / ID" data-translate="searchPlaceholder">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="trackClassSelect"><option value="" data-translate="allClasses">All Classes</option></select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="feesSessionFilter"></select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="feesTermFilter">
                            <option value="" data-translate="allTerms">All Terms</option>
                            <option value="1" data-translate="firstTerm">1st Term</option>
                            <option value="2" data-translate="secondTerm">2nd Term</option>
                            <option value="3" data-translate="thirdTerm">3rd Term</option>
                        </select>
                    </div>
                </div>

                <!-- Export -->
                <div class="d-flex justify-content-end gap-2 mb-3">
                    <button class="btn btn-outline-primary" id="exportPaymentsPdfBtn" data-translate="exportPdf">PDF</button>
                    <button class="btn btn-outline-success" id="exportPaymentsExcelBtn" data-translate="exportExcel">Excel</button>
                </div>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th data-translate="studentId">Student ID</th>
                                <th data-translate="studentName">Student Name</th>
                                <th data-translate="class">Class</th>
                                <th data-translate="guardianPhone">Guardian Phone</th>
                                <th data-translate="totalFee">Total Fee</th>
                                <th data-translate="amountPaid">Paid</th>
                                <th data-translate="remaining">Remaining</th>
                                <th data-translate="status">Status</th>
                            </tr>
                        </thead>
                        <tbody id="paymentTableBody"><!-- filled by JS --></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==== FEE STRUCTURE OVERVIEW ==== -->
        <div id="feeStructureOverviewSection" class="tab-pane fade">
            <div class="bg-white p-4 rounded shadow">
                <h5 class="mb-3" data-translate="feeStructureOverview">Fee Structure Overview</h5>

                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <select class="form-select" id="feeOverviewSessionFilter"></select>
                    </div>
                    <div class="col-md-6">
                        <select class="form-select" id="feeOverviewTermFilter">
                            <option value="" data-translate="allTerms">All Terms</option>
                            <option value="1" data-translate="firstTerm">1st Term</option>
                            <option value="2" data-translate="secondTerm">2nd Term</option>
                            <option value="3" data-translate="thirdTerm">3rd Term</option>
                        </select>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mb-3">
                    <button class="btn btn-outline-primary" id="exportFeeStructurePdfBtn" data-translate="exportPdf">PDF</button>
                    <button class="btn btn-outline-success" id="exportFeeStructureExcelBtn" data-translate="exportExcel">Excel</button>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th data-translate="class">Class</th>
                                <th data-translate="section">Section</th>
                                <th data-translate="term">Term</th>
                                <th data-translate="totalFee">Total Fee (₦)</th>
                                <th data-translate="description">Description</th>
                            </tr>
                        </thead>
                        <tbody id="feeStructureTableBody"><!-- filled by JS --></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= ADD PAYMENT MODAL ================= -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addPaymentModalLabel" data-translate="addPayment">Add Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPaymentForm" novalidate>
                    <!-- hidden fields used by JS -->
                    <input type="hidden" id="paymentStudentFeeId">
                    <input type="hidden" id="paymentStudentName">
                    <input type="hidden" id="paymentClassSection">
                    <input type="hidden" id="paymentClassRef">

                    <!-- Student ID -->
                    <div class="mb-3">
                        <label class="form-label" data-translate="studentId">Student ID (e.g. STU001)</label>
                        <input type="text" class="form-control" id="paymentStudentId" placeholder="Enter Student ID" required>
                        <div class="form-text text-muted" id="studentInfo"></div>
                        <div class="invalid-feedback" data-translate="studentRequired">Enter a valid ID.</div>
                    </div>

                    <!-- Session -->
                    <div class="mb-3">
                        <label class="form-label" data-translate="session">Session</label>
                        <select class="form-select" id="paymentSession" required></select>
                        <div class="invalid-feedback" data-translate="sessionRequired">Session required.</div>
                    </div>

                    <!-- Term -->
                    <div class="mb-3">
                        <label class="form-label" data-translate="term">Term</label>
                        <select class="form-select" id="paymentTerm" required>
                            <option value="" data-translate="selectTerm">Select Term</option>
                            <option value="1" data-translate="firstTerm">1st Term</option>
                            <option value="2" data-translate="secondTerm">2nd Term</option>
                            <option value="3" data-translate="thirdTerm">3rd Term</option>
                        </select>
                        <div class="invalid-feedback" data-translate="termRequired">Term required.</div>
                    </div>

                    <!-- Fee Info -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label" data-translate="totalFee">Total Fee (₦)</label>
                            <input type="text" class="form-control" id="paymentTotalFee" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" data-translate="remainingAmount">Remaining (₦)</label>
                            <input type="text" class="form-control" id="paymentRemaining" readonly>
                        </div>
                    </div>

                    <!-- Amount to pay -->
                    <div class="mb-3">
                        <label class="form-label" data-translate="paymentAmount">Amount to Pay (₦)</label>
                        <input type="number" class="form-control" id="paymentAmount" min="1" step="0.01" required>
                        <div class="invalid-feedback" data-translate="amountRequired">Enter a positive amount.</div>
                    </div>

                    <!-- Method -->
                    <div class="mb-3">
                        <label class="form-label" data-translate="paymentMethod">Payment Method</label>
                        <select class="form-select" id="paymentMethod">
                            <option value="Cash" data-translate="cash">Cash</option>
                            <option value="Bank Transfer" data-translate="bankTransfer">Bank Transfer</option>
                            <option value="POS" data-translate="pos">POS</option>
                            <option value="Cheque" data-translate="cheque">Cheque</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label class="form-label" data-translate="notes">Notes (Optional)</label>
                        <textarea class="form-control" id="paymentNotes" rows="2"></textarea>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg" data-translate="submitPayment">Submit Payment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

please make the add payment button to display the modal and let me enter the student id and get the student name and class based on that class i get the total amonut to be paid by student in that class the get what is pending if let say i paid some part. then update the database with payment and be able to get receipt automatically