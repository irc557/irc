<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --accent-color: #fbbc05;
            --background-color: #f5f7fa;
            --text-color: #202124;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            margin: 0;
        }

        .sidebar {
            width: 260px;
            background-color: #202124;
            color: #fff;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            padding-top: 1rem;
            transition: transform 0.3s ease-in-out;
        }

        .sidebar.collapsed {
            transform: translateX(-260px);
        }

        .sidebar .nav-link {
            color: #bdc1c6;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: #fff;
        }

        .sidebar .nav-link i {
            margin-right: 0.75rem;
            width: 1.25rem;
            text-align: center;
        }

        .main-content {
            margin-left: 260px;
            padding: 1.5rem;
            transition: margin-left 0.3s ease-in-out;
        }

        .dashboard-card {
            background: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .card-gradient-1 {
            background-image: linear-gradient(135deg, #4285f4, #669df6);
        }

        .card-gradient-2 {
            background-image: linear-gradient(135deg, #34a853, #57b76f);
        }

        .card-gradient-3 {
            background-image: linear-gradient(135deg, #fbbc05, #fbdc59);
        }

        .card-gradient-4 {
            background-image: linear-gradient(135deg, #ea4335, #f28b82);
        }

        #sidebarToggleMobile {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1101;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            display: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-260px);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            #sidebarToggleMobile {
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="p-4 border-b border-gray-700">
            <!-- Added profile picture and improved staff info display -->
            <div class="flex items-center mb-3">
                <img id="staffProfilePicture" src="/uploads/staff/default.jpg" alt="Profile" class="w-16 h-16 rounded-full object-cover border-2 border-gray-600">
                <div class="ml-3">
                    <h3 class="text-lg font-bold text-white" id="staffNameDisplay">Loading...</h3>
                    <p class="text-xs text-gray-400">Staff ID: <span id="staffIdDisplay">N/A</span></p>
                </div>
            </div>
            <p class="text-sm text-gray-400">Role: <span id="staffRoleDisplay">N/A</span></p>
        </div>
        <ul class="nav flex-column mt-4" id="sidebarNav">
            <li class="nav-item">
                <a href="#" class="nav-link active" data-view="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-view="attendance"><i class="fas fa-clipboard-check"></i> Attendance</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-view="memorization"><i class="fas fa-book-quran"></i> Tahfiz Assessment</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-view="subjects"><i class="fas fa-chalkboard-teacher"></i> Subject Scores</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-view="reports"><i class="fas fa-file-alt"></i> Reports</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-view="videos"><i class="fas fa-video"></i> Upload Videos</a>
            </li>
        </ul>
        <div class="mt-auto p-4">
            <a href="#" class="d-flex align-items-center text-white text-decoration-none" id="logoutBtn">
                <i class="fas fa-sign-out-alt me-2"></i>
                <strong>Logout</strong>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <button id="sidebarToggleMobile">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Dashboard View -->
        <div id="dashboard-view">
            <h2 class="text-2xl font-semibold mb-4">Dashboard Overview</h2>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
                <div class="dashboard-card card-gradient-1 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="text-sm font-medium opacity-90">My Classes</h5>
                            <p id="totalClassesCount" class="text-4xl font-bold mt-1">0</p>
                        </div>
                        <div class="p-3 rounded-full bg-white bg-opacity-20">
                            <i class="fas fa-chalkboard text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card card-gradient-2 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="text-sm font-medium opacity-90">My Students</h5>
                            <p id="totalStudentsCount" class="text-4xl font-bold mt-1">0</p>
                        </div>
                        <div class="p-3 rounded-full bg-white bg-opacity-20">
                            <i class="fas fa-user-graduate text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card card-gradient-3 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="text-sm font-medium opacity-90">Attendance Today</h5>
                            <p id="attendanceTodayCount" class="text-4xl font-bold mt-1">0%</p>
                        </div>
                        <div class="p-3 rounded-full bg-white bg-opacity-20">
                            <i class="fas fa-clipboard-check text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card card-gradient-4 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="text-sm font-medium opacity-90">Average Grade</h5>
                            <p id="averageGradeCount" class="text-4xl font-bold mt-1">0</p>
                        </div>
                        <div class="p-3 rounded-full bg-white bg-opacity-20">
                            <i class="fas fa-chart-line text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance View -->
        <div id="attendance-view" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4">Attendance Management</h2>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="mb-3 flex flex-wrap gap-2">
                    <select class="form-select w-full sm:w-auto" id="attendanceClassSelect">
                        <option value="">Select Class</option>
                    </select>
                    <input type="date" class="form-control w-full sm:w-auto" id="attendanceDate">
                    <select class="form-select w-full sm:w-auto" id="attendanceDay">
                        <option value="السبت">Saturday</option>
                        <option value="الأحد">Sunday</option>
                        <option value="الاثنين">Monday</option>
                        <option value="الثلاثاء">Tuesday</option>
                        <option value="الأربعاء">Wednesday</option>
                        <option value="الخميس">Thursday</option>
                    </select>
                    <button class="btn btn-primary" id="loadAttendanceBtn">Load Attendance</button>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody"></tbody>
                    </table>
                </div>
                <button class="btn btn-success mt-3" id="saveAttendanceBtn">Save Attendance</button>
            </div>
        </div>

        <!-- Memorization View -->
        <div id="memorization-view" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4">Tahfiz Assessment</h2>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="mb-3 flex flex-wrap gap-2">
                    <!-- Reordered selectors: Class -> Session -> Term -> Week -->
                    <select class="form-select w-full sm:w-auto" id="memorizationClassSelect">
                        <option value="">Select Class</option>
                    </select>
                    <select class="form-select w-full sm:w-auto" id="memorizationSessionSelect">
                        <option value="">Select Session</option>
                    </select>
                    <select class="form-select w-full sm:w-auto" id="memorizationTermSelect">
                        <option value="">Select Term</option>
                        <option value="1">1st Term</option>
                        <option value="2">2nd Term</option>
                        <option value="3">3rd Term</option>
                    </select>
                    <select class="form-select w-full sm:w-auto" id="memorizationWeekSelect">
                        <option value="">Select Week</option>
                    </select>
                    <button class="btn btn-primary" id="loadMemorizationBtn">Load Students</button>
                </div>
                <!-- Added ayah range display -->
                <div id="memorizationInfo" class="alert alert-info mb-3" style="display: none;">
                    <strong>Ayah Range:</strong> <span id="ayahRangeDisplay"></span>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Daily Grade (A-F)</th>
                                <th>Exam Score (0-100)</th>
                                <th>Comments</th>
                            </tr>
                        </thead>
                        <tbody id="memorizationTableBody"></tbody>
                    </table>
                </div>
                <button class="btn btn-success mt-3" id="saveMemorizationBtn">Save Assessment</button>
            </div>
        </div>

        <!-- Subjects View -->
        <div id="subjects-view" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4">Subject Scores</h2>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="mb-3 flex flex-wrap gap-2">
                    <select class="form-select w-full sm:w-auto" id="subjectClassSelect">
                        <option value="">Select Class</option>
                    </select>
                    <select class="form-select w-full sm:w-auto" id="subjectSelect">
                        <option value="">Select Subject</option>
                    </select>
                    <select class="form-select w-full sm:w-auto" id="subjectTermSelect">
                        <option value="1">1st Term</option>
                        <option value="2">2nd Term</option>
                        <option value="3">3rd Term</option>
                    </select>
                    <button class="btn btn-primary" id="loadSubjectScoresBtn">Load Students</button>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>CA1 (0-100)</th>
                                <th>CA2 (0-100)</th>
                                <th>CA3 (0-100)</th>
                                <th>Exam (0-100)</th>
                                <th>Comments</th>
                            </tr>
                        </thead>
                        <tbody id="subjectScoresTableBody"></tbody>
                    </table>
                </div>
                <button class="btn btn-success mt-3" id="saveSubjectScoresBtn">Save Scores</button>
            </div>
        </div>

        <!-- Reports View -->
        <div id="reports-view" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4">Reports</h2>
            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <h5 class="mb-3">Generate Student Reports</h5>
                <div class="mb-3 flex flex-wrap gap-2">
                    <select class="form-select w-full sm:w-auto" id="reportClassSelect">
                        <option value="">Select Class</option>
                    </select>
                    <select class="form-select w-full sm:w-auto" id="reportSessionSelect">
                        <option value="">Select Session</option>
                    </select>
                    <select class="form-select w-full sm:w-auto" id="reportTermSelect">
                        <option value="">Select Term</option>
                        <option value="1">1st Term</option>
                        <option value="2">2nd Term</option>
                        <option value="3">3rd Term</option>
                    </select>
                    <button class="btn btn-primary" id="loadReportStudentsBtn">Load Students</button>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportStudentsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Videos View -->
        <div id="videos-view" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4">Upload Memorization Videos</h2>
            <div class="bg-white p-4 rounded-lg shadow">
                <form id="videoUploadForm">
                    <div class="mb-3">
                        <label for="videoTitle" class="form-label">Video Title</label>
                        <input type="text" class="form-control" id="videoTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="videoDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="videoDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="videoWeek" class="form-label">Week</label>
                        <input type="number" class="form-control" id="videoWeek" min="1" max="14" required>
                    </div>
                    <div class="mb-3">
                        <label for="videoFile" class="form-label">Video File</label>
                        <input type="file" class="form-control" id="videoFile" accept="video/*" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload Video</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./js/staff_dashboard.js"></script>
</body>
</html>
// Staff Dashboard JavaScript
let currentStaffId = null
let currentStaffRole = null
let currentStaffInfo = null

// Initialize dashboard
document.addEventListener("DOMContentLoaded", async () => {
  await loadStaffInfo()
  await loadDashboardStats()
  await loadSessions()
  setupEventListeners()
})

// Load staff information
async function loadStaffInfo() {
  try {
    const sessionResponse = await fetch("/api/staff-session")
    const sessionData = await sessionResponse.json()

    if (!sessionData.success) {
      console.error("Failed to get staff session")
      window.location.href = "/staff-login"
      return
    }

    const staffId = sessionData.data.staff_id
    const response = await fetch(`/api/staff/${staffId}`)
    const data = await response.json()

    if (data.success) {
      currentStaffInfo = data.data
      currentStaffId = data.data.id
      currentStaffRole = data.data.role

      // Display staff info in sidebar
      document.getElementById("staffIdDisplay").textContent = data.data.staff_id || "N/A"
      document.getElementById("staffRoleDisplay").textContent = data.data.role || "N/A"
      document.getElementById("staffNameDisplay").textContent = data.data.name || "Staff"

      // Display profile picture
      const profilePic = document.getElementById("staffProfilePicture")
      if (data.data.profile_picture) {
        profilePic.src = data.data.profile_picture
      }
    } else {
      console.error("Failed to load staff info:", data.message)
    }
  } catch (error) {
    console.error("Error loading staff info:", error)
  }
}

// Load dashboard statistics
async function loadDashboardStats() {
  try {
    const sessionResponse = await fetch("/api/staff-session")
    const sessionData = await sessionResponse.json()

    if (!sessionData.success) {
      console.error("Failed to get staff session")
      return
    }

    const staffId = sessionData.data.staff_id
    const response = await fetch(`/api/staff-dashboard-stats/${staffId}`)
    const data = await response.json()

    if (data.success) {
      document.getElementById("totalClassesCount").textContent = data.data.totalClasses || 0
      document.getElementById("totalStudentsCount").textContent = data.data.totalStudents || 0
      document.getElementById("attendanceTodayCount").textContent = (data.data.attendanceToday || 0).toFixed(1) + "%"
      document.getElementById("averageGradeCount").textContent = (data.data.averageGrade || 0).toFixed(1)
    }
  } catch (error) {
    console.error("Error loading dashboard stats:", error)
  }
}

// Load sessions
async function loadSessions() {
  try {
    const response = await fetch("/api/sessions")
    const data = await response.json()

    if (data.success) {
      const sessionSelects = [
        document.getElementById("memorizationSessionSelect"),
        document.getElementById("reportSessionSelect"),
      ]

      sessionSelects.forEach((select) => {
        if (select) {
          select.innerHTML = '<option value="">Select Session</option>'
          data.data.forEach((session) => {
            const option = document.createElement("option")
            option.value = session.session_year
            option.textContent = session.session_year
            if (session.is_current) {
              option.selected = true
            }
            select.appendChild(option)
          })
        }
      })
    }
  } catch (error) {
    console.error("Error loading sessions:", error)
  }
}

// Setup event listeners
function setupEventListeners() {
  // Navigation
  document.querySelectorAll(".nav-link").forEach((link) => {
    link.addEventListener("click", (e) => {
      e.preventDefault()
      const view = e.currentTarget.getAttribute("data-view")
      switchView(view)
    })
  })

  // Sidebar toggle
  document.getElementById("sidebarToggleMobile")?.addEventListener("click", () => {
    document.getElementById("sidebar").classList.toggle("open")
  })

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", async (e) => {
    e.preventDefault()
    await fetch("/api/staff-logout", { method: "POST" })
    window.location.href = "/staff-login"
  })

  document.getElementById("memorizationTermSelect")?.addEventListener("change", loadMemorizationWeeks)
  document.getElementById("memorizationClassSelect")?.addEventListener("change", () => {
    // Reset term and week when class changes
    document.getElementById("memorizationTermSelect").value = ""
    document.getElementById("memorizationWeekSelect").innerHTML = '<option value="">Select Week</option>'
  })

  // Load buttons
  document.getElementById("loadAttendanceBtn")?.addEventListener("click", loadAttendance)
  document.getElementById("loadMemorizationBtn")?.addEventListener("click", loadMemorization)
  document.getElementById("loadSubjectScoresBtn")?.addEventListener("click", loadSubjectScores)
  document.getElementById("loadReportStudentsBtn")?.addEventListener("click", loadReportStudents)

  // Save buttons
  document.getElementById("saveAttendanceBtn")?.addEventListener("click", saveAttendance)
  document.getElementById("saveMemorizationBtn")?.addEventListener("click", saveMemorization)
  document.getElementById("saveSubjectScoresBtn")?.addEventListener("click", saveSubjectScores)

  // Video upload
  document.getElementById("videoUploadForm")?.addEventListener("submit", uploadVideo)
}

// Switch view
function switchView(view) {
  document.querySelectorAll('[id$="-view"]').forEach((v) => (v.style.display = "none"))
  document.getElementById(`${view}-view`).style.display = "block"

  document.querySelectorAll(".nav-link").forEach((link) => link.classList.remove("active"))
  document.querySelector(`[data-view="${view}"]`).classList.add("active")

  // Load data for specific views
  if (view === "attendance") loadClasses("attendanceClassSelect")
  if (view === "memorization") loadClasses("memorizationClassSelect")
  if (view === "subjects") {
    loadClasses("subjectClassSelect")
    loadSubjects()
  }
  if (view === "reports") loadClasses("reportClassSelect")
}

// Load classes
async function loadClasses(selectId) {
  try {
    if (!currentStaffId) {
      console.error("Staff ID not loaded")
      return
    }

    // Fetch staff's assigned classes
    const response = await fetch(`/api/staff/${currentStaffId}`)
    const data = await response.json()

    if (data.success && data.data.classes) {
      const select = document.getElementById(selectId)
      select.innerHTML = '<option value="">Select Class</option>'

      // Fetch class names
      const classesResponse = await fetch("/api/classes")
      const classesData = await classesResponse.json()

      if (classesData.success) {
        data.data.classes.forEach((staffClass) => {
          const classInfo = classesData.data.find(
            (c) => c.id === staffClass.class_id && c.section_id === staffClass.section_id,
          )

          if (classInfo) {
            const option = document.createElement("option")
            option.value = `${staffClass.section_id}:${staffClass.class_id}`
            option.textContent = classInfo.name
            select.appendChild(option)
          }
        })
      }
    }
  } catch (error) {
    console.error("Error loading classes:", error)
  }
}

// Load subjects
async function loadSubjects() {
  try {
    const sessionResponse = await fetch("/api/staff-session")
    const sessionData = await sessionResponse.json()

    if (!sessionData.success) return

    const staffId = sessionData.data.staff_id
    const response = await fetch(`/api/staff-subjects/${staffId}?section_id=1`)
    const data = await response.json()

    if (data.success) {
      const select = document.getElementById("subjectSelect")
      select.innerHTML = '<option value="">Select Subject</option>'
      data.data.forEach((subject) => {
        const option = document.createElement("option")
        option.value = subject.subject_id
        option.textContent = subject.subject_name
        select.appendChild(option)
      })
    }
  } catch (error) {
    console.error("Error loading subjects:", error)
  }
}

// Load memorization weeks
async function loadMemorizationWeeks() {
  const classValue = document.getElementById("memorizationClassSelect").value
  const term = document.getElementById("memorizationTermSelect").value

  if (!classValue || !term) {
    document.getElementById("memorizationWeekSelect").innerHTML = '<option value="">Select Week</option>'
    return
  }

  const [sectionId, classId] = classValue.split(":")

  try {
    const response = await fetch(`/api/staff-memorization-weeks?class_id=${classId}&term=${term}`)
    const data = await response.json()

    if (data.success) {
      const select = document.getElementById("memorizationWeekSelect")
      select.innerHTML = '<option value="">Select Week</option>'
      data.data.forEach((week) => {
        const option = document.createElement("option")
        option.value = week.week
        option.textContent = `Week ${week.week}`
        select.appendChild(option)
      })
    }
  } catch (error) {
    console.error("Error loading weeks:", error)
  }
}

// Load attendance
async function loadAttendance() {
  const classValue = document.getElementById("attendanceClassSelect").value
  const date = document.getElementById("attendanceDate").value
  const day = document.getElementById("attendanceDay").value

  if (!classValue || !date || !day) {
    alert("Please select class, date, and day")
    return
  }

  const [sectionId, classId] = classValue.split(":")

  try {
    const sessionResponse = await fetch("/api/staff-session")
    const sessionData = await sessionResponse.json()

    if (!sessionData.success) return

    const staffId = sessionData.data.staff_id
    const response = await fetch(
      `/api/staff-attendance/${staffId}?section_id=${sectionId}&class_id=${classId}&date=${date}&day=${day}`,
    )
    const data = await response.json()

    if (data.success) {
      const tbody = document.getElementById("attendanceTableBody")
      tbody.innerHTML = ""

      data.data.forEach((student) => {
        const row = document.createElement("tr")
        row.innerHTML = `
                    <td>${student.student_name}</td>
                    <td>
                        <select class="form-select" data-enrollment-id="${student.enrollment_id}">
                            <option value="Present" ${student.attendance_status === "Present" ? "selected" : ""}>Present</option>
                            <option value="Absent" ${student.attendance_status === "Absent" ? "selected" : ""}>Absent</option>
                        </select>
                    </td>
                `
        tbody.appendChild(row)
      })
    }
  } catch (error) {
    console.error("Error loading attendance:", error)
  }
}

// Save attendance
async function saveAttendance() {
  const classValue = document.getElementById("attendanceClassSelect").value
  const date = document.getElementById("attendanceDate").value
  const day = document.getElementById("attendanceDay").value

  if (!classValue || !date || !day) {
    alert("Please select class, date, and day")
    return
  }

  const [sectionId, classId] = classValue.split(":")
  const attendance = []

  document.querySelectorAll("#attendanceTableBody select").forEach((select) => {
    attendance.push({
      enrollment_id: select.getAttribute("data-enrollment-id"),
      attendance_status: select.value,
      date: date,
      day: day,
    })
  })

  try {
    const sessionResponse = await fetch("/api/staff-session")
    const sessionData = await sessionResponse.json()

    if (!sessionData.success) return

    const staffId = sessionData.data.staff_id
    const response = await fetch(`/api/staff-attendance/${staffId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ section_id: sectionId, class_id: classId, attendance }),
    })

    const data = await response.json()

    if (data.success) {
      alert("Attendance saved successfully")
    } else {
      alert("Failed to save attendance: " + data.message)
    }
  } catch (error) {
    console.error("Error saving attendance:", error)
    alert("Error saving attendance")
  }
}

// Load memorization
async function loadMemorization() {
  const classValue = document.getElementById("memorizationClassSelect").value
  const session = document.getElementById("memorizationSessionSelect").value
  const term = document.getElementById("memorizationTermSelect").value
  const week = document.getElementById("memorizationWeekSelect").value

  if (!classValue || !session || !term || !week) {
    alert("Please select all fields")
    return
  }

  const [sectionId, classId] = classValue.split(":")

  try {
    const response = await fetch(
      `/api/staff-memorization/${currentStaffId}?section_id=${sectionId}&class_id=${classId}&term=${term}&week=${week}&session=${session}`,
    )
    const data = await response.json()

    if (data.success && data.data.length > 0) {
      const firstRecord = data.data[0]

      // Display ayah range
      document.getElementById("memorizationInfo").style.display = "block"
      document.getElementById("ayahRangeDisplay").textContent =
        `Week ${firstRecord.week} - ${firstRecord.day}: ${firstRecord.from_surah_ayah} to ${firstRecord.to_surah_ayah}`

      const tbody = document.getElementById("memorizationTableBody")
      tbody.innerHTML = ""

      data.data.forEach((student) => {
        const row = document.createElement("tr")
        row.innerHTML = `
                    <td>${student.student_name}</td>
                    <td>
                        <select class="form-select" data-enrollment-id="${student.enrollment_id}" data-scheme-id="${student.scheme_id}">
                            <option value="">-</option>
                            <option value="A" ${student.daily_grade === "A" ? "selected" : ""}>A</option>
                            <option value="B" ${student.daily_grade === "B" ? "selected" : ""}>B</option>
                            <option value="C" ${student.daily_grade === "C" ? "selected" : ""}>C</option>
                            <option value="D" ${student.daily_grade === "D" ? "selected" : ""}>D</option>
                            <option value="E" ${student.daily_grade === "E" ? "selected" : ""}>E</option>
                            <option value="F" ${student.daily_grade === "F" ? "selected" : ""}>F</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" class="form-control" min="0" max="100" 
                               value="${student.exam_grade || ""}" 
                               data-enrollment-id="${student.enrollment_id}"
                               data-scheme-id="${student.scheme_id}">
                    </td>
                    <td>
                        <input type="text" class="form-control" value="${student.comments || ""}" 
                               data-enrollment-id="${student.enrollment_id}"
                               data-scheme-id="${student.scheme_id}">
                    </td>
                `
        tbody.appendChild(row)
      })
    } else {
      alert("No students found for this selection")
    }
  } catch (error) {
    console.error("Error loading memorization:", error)
    alert("Error loading memorization data")
  }
}

// Save memorization
async function saveMemorization() {
  const classValue = document.getElementById("memorizationClassSelect").value
  const session = document.getElementById("memorizationSessionSelect").value
  const term = document.getElementById("memorizationTermSelect").value
  const week = document.getElementById("memorizationWeekSelect").value

  if (!classValue || !session || !term || !week) {
    alert("Please select all fields")
    return
  }

  const [sectionId, classId] = classValue.split(":")
  const assessments = []

  document.querySelectorAll("#memorizationTableBody tr").forEach((row) => {
    const enrollmentId = row.querySelector("select").getAttribute("data-enrollment-id")
    const schemeId = row.querySelector("select").getAttribute("data-scheme-id")
    const dailyGrade = row.querySelector("select").value
    const examGrade = row.querySelector('input[type="number"]').value
    const comments = row.querySelector('input[type="text"]').value

    assessments.push({
      enrollment_id: enrollmentId,
      scheme_id: schemeId,
      daily_grade: dailyGrade || null,
      exam_grade: examGrade ? Number.parseInt(examGrade) : null,
      comments: comments,
      academic_year: session, // Include session for saving
      term: Number.parseInt(term),
    })
  })

  try {
    const response = await fetch(`/api/staff-memorization/${currentStaffId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        section_id: sectionId,
        class_id: classId,
        term: term,
        week: week,
        session: session,
        assessments,
      }),
    })

    const data = await response.json()

    if (data.success) {
      alert("Memorization assessment saved successfully")
      loadMemorization() // Reload to show updated data
    } else {
      alert("Failed to save assessment: " + data.message)
    }
  } catch (error) {
    console.error("Error saving memorization:", error)
    alert("Error saving assessment")
  }
}

// Load subject scores
async function loadSubjectScores() {
  const classValue = document.getElementById("subjectClassSelect").value
  const subjectId = document.getElementById("subjectSelect").value
  const term = document.getElementById("subjectTermSelect").value

  if (!classValue || !subjectId || !term) {
    alert("Please select all fields")
    return
  }

  const [sectionId, classId] = classValue.split(":")

  try {
    const sessionResponse = await fetch("/api/staff-session")
    const sessionData = await sessionResponse.json()

    if (!sessionData.success) return

    const staffId = sessionData.data.staff_id
    const response = await fetch(
      `/api/staff-assessments/${staffId}?section_id=${sectionId}&class_id=${classId}&subject_id=${subjectId}`,
    )
    const data = await response.json()

    if (data.success) {
      const tbody = document.getElementById("subjectScoresTableBody")
      tbody.innerHTML = ""

      data.data.forEach((student) => {
        const row = document.createElement("tr")
        row.innerHTML = `
                    <td>${student.student_name}</td>
                    <td><input type="number" class="form-control" min="0" max="100" value="${student.ca1_score || ""}" data-enrollment-id="${student.enrollment_id}" data-field="ca1"></td>
                    <td><input type="number" class="form-control" min="0" max="100" value="${student.ca2_score || ""}" data-enrollment-id="${student.enrollment_id}" data-field="ca2"></td>
                    <td><input type="number" class="form-control" min="0" max="100" value="${student.ca3_score || ""}" data-enrollment-id="${student.enrollment_id}" data-field="ca3"></td>
                    <td><input type="number" class="form-control" min="0" max="100" value="${student.exam_score || ""}" data-enrollment-id="${student.enrollment_id}" data-field="exam"></td>
                    <td><input type="text" class="form-control" value="${student.comments || ""}" data-enrollment-id="${student.enrollment_id}" data-field="comments"></td>
                `
        tbody.appendChild(row)
      })
    }
  } catch (error) {
    console.error("Error loading subject scores:", error)
  }
}

// Save subject scores
async function saveSubjectScores() {
  const classValue = document.getElementById("subjectClassSelect").value
  const subjectId = document.getElementById("subjectSelect").value
  const term = document.getElementById("subjectTermSelect").value

  if (!classValue || !subjectId || !term) {
    alert("Please select all fields")
    return
  }

  const [sectionId, classId] = classValue.split(":")
  const assessments = []

  const rows = document.querySelectorAll("#subjectScoresTableBody tr")
  rows.forEach((row) => {
    const inputs = row.querySelectorAll("input")
    const enrollmentId = inputs[0].getAttribute("data-enrollment-id")

    assessments.push({
      enrollment_id: enrollmentId,
      ca1_score: inputs[0].value || null,
      ca2_score: inputs[1].value || null,
      ca3_score: inputs[2].value || null,
      exam_score: inputs[3].value || null,
      comments: inputs[4].value,
      date: new Date().toISOString().split("T")[0],
    })
  })

  try {
    const sessionResponse = await fetch("/api/staff-session")
    const sessionData = await sessionResponse.json()

    if (!sessionData.success) return

    const staffId = sessionData.data.staff_id
    const response = await fetch(`/api/staff-assessments/${staffId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        section_id: sectionId,
        class_id: classId,
        subject_id: subjectId,
        term: term,
        assessments,
      }),
    })

    const data = await response.json()

    if (data.success) {
      alert("Subject scores saved successfully")
    } else {
      alert("Failed to save scores: " + data.message)
    }
  } catch (error) {
    console.error("Error saving subject scores:", error)
    alert("Error saving scores")
  }
}

// Load report students
async function loadReportStudents() {
  const classValue = document.getElementById("reportClassSelect").value
  const session = document.getElementById("reportSessionSelect").value
  const term = document.getElementById("reportTermSelect").value

  if (!classValue || !session || !term) {
    alert("Please select all fields")
    return
  }

  const [sectionId, classId] = classValue.split(":")

  try {
    const sessionResponse = await fetch("/api/staff-session")
    const sessionData = await sessionResponse.json()

    if (!sessionData.success) return

    const staffId = sessionData.data.staff_id
    const response = await fetch(`/api/staff-students/${staffId}?section_id=${sectionId}&class_id=${classId}`)
    const data = await response.json()

    if (data.success) {
      const tbody = document.getElementById("reportStudentsTableBody")
      tbody.innerHTML = ""

      data.data.forEach((student) => {
        const row = document.createElement("tr")
        row.innerHTML = `
                    <td>${student.full_name}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" onclick="downloadSubjectReport('${student.student_id}', '${session}', '${term}')">
                            <i class="fas fa-download"></i> Subject Report
                        </button>
                        <button class="btn btn-sm btn-success" onclick="downloadTahfizReport('${student.student_id}', '${session}', '${term}')">
                            <i class="fas fa-download"></i> Tahfiz Report
                        </button>
                    </td>
                `
        tbody.appendChild(row)
      })
    }
  } catch (error) {
    console.error("Error loading students:", error)
  }
}

// Download subject report
window.downloadSubjectReport = async (studentId, session, term) => {
  window.open(`/api/student-report?student_id=${studentId}&session=${session}&term=${term}&type=subject`, "_blank")
}

// Download tahfiz report
window.downloadTahfizReport = async (studentId, session, term) => {
  window.open(`/api/student-report?student_id=${studentId}&session=${session}&term=${term}&type=tahfiz`, "_blank")
}

// Download complete report
window.downloadCompleteReport = async (studentId, session, term) => {
  window.open(`/api/student-report?student_id=${studentId}&session=${session}&term=${term}&type=complete`, "_blank")
}

// Upload video
async function uploadVideo(e) {
  e.preventDefault()

  const formData = new FormData()
  formData.append("title", document.getElementById("videoTitle").value)
  formData.append("description", document.getElementById("videoDescription").value)
  formData.append("week", document.getElementById("videoWeek").value)
  formData.append("video", document.getElementById("videoFile").files[0])

  try {
    const response = await fetch("/api/upload-memorization-video", {
      method: "POST",
      body: formData,
    })

    const data = await response.json()

    if (data.success) {
      alert("Video uploaded successfully")
      document.getElementById("videoUploadForm").reset()
    } else {
      alert("Failed to upload video: " + data.message)
    }
  } catch (error) {
    console.error("Error uploading video:", error)
    alert("Error uploading video")
  }
}
